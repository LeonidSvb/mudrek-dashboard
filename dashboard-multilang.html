<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard Pro - Multilingual</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: direction 0.3s ease;
        }

        body[dir="rtl"] {
            font-family: 'Segoe UI', 'Arial', 'Tahoma', sans-serif;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: #333;
            font-size: 2.2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .language-switcher {
            display: flex;
            gap: 10px;
            background: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .lang-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: #f0f0f0;
        }

        .lang-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .currency-toggle {
            display: flex;
            gap: 5px;
            background: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .currency-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .currency-btn:hover {
            background: #f0f0f0;
        }

        .currency-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            color: #666;
            font-weight: 600;
            font-size: 14px;
        }

        .filter-group input, .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .metric-label {
            color: #666;
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            line-height: 1.2;
        }

        .metric-change {
            font-size: 13px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .metric-change.positive {
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .chart-card canvas {
            max-height: 300px !important;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .funnel-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 15px;
            max-height: 350px;
            overflow-y: auto;
        }

        .funnel-stage {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .funnel-bar {
            height: 40px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .funnel-bar:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .funnel-label {
            min-width: 140px;
            font-weight: 600;
            color: #333;
        }

        .funnel-metrics {
            display: flex;
            gap: 20px;
            color: white;
            font-size: 14px;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            letter-spacing: 0.3px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        [dir="rtl"] th {
            text-align: right;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-badge.lead {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.qualified {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.proposal {
            background: #e9d5ff;
            color: #6b21a8;
        }

        .status-badge.closed-won {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.closed-lost {
            background: #fee2e2;
            color: #991b1b;
        }

        .file-input-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px dashed #667eea;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s ease;
        }

        .file-input-label:hover {
            transform: scale(1.05);
        }

        #csvFile {
            display: none;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 20px;
            padding: 50px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        [dir="rtl"] .funnel-bar:hover {
            transform: translateX(-10px);
        }

        [dir="rtl"] .metric-change {
            flex-direction: row-reverse;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1 id="dashboardTitle">üìä Sales Dashboard Pro</h1>
            <div class="controls">
                <div class="language-switcher">
                    <button class="lang-btn active" onclick="setLanguage('en')">EN</button>
                    <button class="lang-btn" onclick="setLanguage('ar')">AR</button>
                    <button class="lang-btn" onclick="setLanguage('he')">HE</button>
                </div>
                <div class="currency-toggle">
                    <button class="currency-btn active" onclick="setCurrency('ILS')">‚Ç™ ILS</button>
                    <button class="currency-btn" onclick="setCurrency('USD')">$ USD</button>
                </div>
            </div>
        </div>

        <div class="file-input-container">
            <label for="csvFile" class="file-input-label" id="uploadLabel">
                üìÇ Upload HubSpot CSV File
            </label>
            <input type="file" id="csvFile" accept=".csv">
            <div id="fileName" style="margin-top: 10px; color: #666;"></div>
        </div>

        <div class="filters" style="display: none;" id="filtersContainer">
            <div class="filter-group">
                <label for="dateFrom" data-i18n="from_date">From Date:</label>
                <input type="date" id="dateFrom">
            </div>
            <div class="filter-group">
                <label for="dateTo" data-i18n="to_date">To Date:</label>
                <input type="date" id="dateTo">
            </div>
            <div class="filter-group">
                <label for="dealOwner" data-i18n="manager">Manager:</label>
                <select id="dealOwner">
                    <option value="" data-i18n="all_managers">All Managers</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="dealStage" data-i18n="deal_stage">Deal Stage:</label>
                <select id="dealStage">
                    <option value="" data-i18n="all_stages">All Stages</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="trafficSource" data-i18n="traffic_source">Traffic Source:</label>
                <select id="trafficSource">
                    <option value="" data-i18n="all_sources">All Sources</option>
                </select>
            </div>
        </div>

        <div id="dashboardContent" style="display: none;">
            <div class="metrics-grid" id="metricsGrid">
                <!-- Metrics will be added dynamically -->
            </div>

            <div class="stats-row" id="additionalStats">
                <!-- Additional stats will be added here -->
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title"><span>üìà</span> <span data-i18n="sales_trend">Sales Trend</span></h3>
                    <canvas id="salesChart"></canvas>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><span>üéØ</span> <span data-i18n="sales_funnel">Sales Funnel</span></h3>
                    <div id="funnelChart" class="funnel-container"></div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><span>üë•</span> <span data-i18n="top_performers">Top Performers</span></h3>
                    <canvas id="managersChart"></canvas>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><span>üìä</span> <span data-i18n="deal_distribution">Deal Distribution</span></h3>
                    <canvas id="dealsDistribution"></canvas>
                </div>

                <div class="chart-card full-width">
                    <h3 class="chart-title"><span>üåê</span> <span data-i18n="traffic_sources">Traffic Sources Analysis</span></h3>
                    <canvas id="trafficChart"></canvas>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><span>üí≥</span> <span data-i18n="payment_methods">Payment Methods</span></h3>
                    <canvas id="paymentMethodsChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3 class="chart-title"><span>üìã</span> <span data-i18n="recent_deals">Recent Deals</span></h3>
                <table id="dealsTable">
                    <thead>
                        <tr>
                            <th data-i18n="deal_name">Deal Name</th>
                            <th data-i18n="manager">Manager</th>
                            <th data-i18n="amount">Amount</th>
                            <th data-i18n="installments">Installments</th>
                            <th data-i18n="stage">Stage</th>
                            <th data-i18n="source">Source</th>
                            <th data-i18n="activities">Activities</th>
                            <th data-i18n="created">Created</th>
                            <th data-i18n="days_to_close">Days to Close</th>
                        </tr>
                    </thead>
                    <tbody id="dealsTableBody">
                        <!-- Rows will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Translation dictionary
        const translations = {
            en: {
                dashboard_title: 'üìä Sales Dashboard Pro',
                upload_label: 'üìÇ Upload HubSpot CSV File',
                from_date: 'From Date:',
                to_date: 'To Date:',
                manager: 'Manager:',
                deal_stage: 'Deal Stage:',
                traffic_source: 'Traffic Source:',
                all_managers: 'All Managers',
                all_stages: 'All Stages',
                all_sources: 'All Sources',
                total_deals: 'Total Deals',
                total_revenue: 'Total Revenue',
                average_deal: 'Average Deal',
                conversion_rate: 'Conversion Rate',
                closed_deals: 'Closed Deals',
                qualified_leads: 'Qualified Leads',
                avg_activities: 'Avg Activities/Deal',
                avg_days_close: 'Avg Days to Close',
                total_installments: 'Total Installments',
                sales_trend: 'Sales Trend',
                sales_funnel: 'Sales Funnel',
                top_performers: 'Top Performers',
                deal_distribution: 'Deal Distribution',
                traffic_sources: 'Traffic Sources Analysis',
                payment_methods: 'Payment Methods',
                recent_deals: 'Recent Deals',
                deal_name: 'Deal Name',
                amount: 'Amount',
                installments: 'Installments',
                stage: 'Stage',
                source: 'Source',
                activities: 'Activities',
                created: 'Created',
                days_to_close: 'Days to Close',
                this_month: 'this month',
                this_week: 'this week',
                deals: 'deals',
                avg_installments: 'Avg Installments',
                first_payment_rate: 'First Payment Rate',
                contacted_rate: 'Contact Rate',
                lead_sources: 'Lead Sources'
            },
            ar: {
                dashboard_title: 'üìä ŸÑŸàÿ≠ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™',
                upload_label: 'üìÇ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ CSV ŸÖŸÜ HubSpot',
                from_date: 'ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ:',
                to_date: 'ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ:',
                manager: 'ÿßŸÑŸÖÿØŸäÿ±:',
                deal_stage: 'ŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿµŸÅŸÇÿ©:',
                traffic_source: 'ŸÖÿµÿØÿ± ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™:',
                all_managers: 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿØŸäÿ±ŸäŸÜ',
                all_stages: 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ',
                all_sources: 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿµÿßÿØÿ±',
                total_deals: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿµŸÅŸÇÿßÿ™',
                total_revenue: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™',
                average_deal: 'ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿµŸÅŸÇÿ©',
                conversion_rate: 'ŸÖÿπÿØŸÑ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ',
                closed_deals: 'ÿßŸÑÿµŸÅŸÇÿßÿ™ ÿßŸÑŸÖÿ∫ŸÑŸÇÿ©',
                qualified_leads: 'ÿßŸÑÿπŸÖŸÑÿßÿ° ÿßŸÑŸÖÿ§ŸáŸÑŸàŸÜ',
                avg_activities: 'ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©/ÿßŸÑÿµŸÅŸÇÿ©',
                avg_days_close: 'ŸÖÿ™Ÿàÿ≥ÿ∑ ÿ£ŸäÿßŸÖ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ',
                total_installments: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑',
                sales_trend: 'ÿßÿ™ÿ¨ÿßŸá ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™',
                sales_funnel: 'ŸÇŸÖÿπ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™',
                top_performers: 'ÿ£ŸÅÿ∂ŸÑ ÿßŸÑÿ£ÿØÿßÿ°',
                deal_distribution: 'ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿµŸÅŸÇÿßÿ™',
                traffic_sources: 'ÿ™ÿ≠ŸÑŸäŸÑ ŸÖÿµÿßÿØÿ± ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™',
                payment_methods: 'ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ',
                recent_deals: 'ÿßŸÑÿµŸÅŸÇÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©',
                deal_name: 'ÿßÿ≥ŸÖ ÿßŸÑÿµŸÅŸÇÿ©',
                amount: 'ÿßŸÑŸÖÿ®ŸÑÿ∫',
                installments: 'ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑',
                stage: 'ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©',
                source: 'ÿßŸÑŸÖÿµÿØÿ±',
                activities: 'ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©',
                created: 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°',
                days_to_close: 'ÿ£ŸäÿßŸÖ ŸÑŸÑÿ•ÿ∫ŸÑÿßŸÇ',
                this_month: 'Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±',
                this_week: 'Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ',
                deals: 'ÿµŸÅŸÇÿßÿ™',
                avg_installments: 'ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑',
                first_payment_rate: 'ŸÖÿπÿØŸÑ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑÿ£ŸàŸÑŸâ',
                contacted_rate: 'ŸÖÿπÿØŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ',
                lead_sources: 'ŸÖÿµÿßÿØÿ± ÿßŸÑÿπŸÖŸÑÿßÿ°'
            },
            he: {
                dashboard_title: 'üìä ◊ú◊ï◊ó ◊û◊ó◊ï◊ï◊†◊ô◊ù ◊ú◊û◊õ◊ô◊®◊ï◊™',
                upload_label: 'üìÇ ◊î◊¢◊ú◊î ◊ß◊ï◊ë◊• CSV ◊û-HubSpot',
                from_date: '◊û◊™◊ê◊®◊ô◊ö:',
                to_date: '◊¢◊ì ◊™◊ê◊®◊ô◊ö:',
                manager: '◊û◊†◊î◊ú:',
                deal_stage: '◊©◊ú◊ë ◊î◊¢◊°◊ß◊î:',
                traffic_source: '◊û◊ß◊ï◊® ◊™◊†◊ï◊¢◊î:',
                all_managers: '◊õ◊ú ◊î◊û◊†◊î◊ú◊ô◊ù',
                all_stages: '◊õ◊ú ◊î◊©◊ú◊ë◊ô◊ù',
                all_sources: '◊õ◊ú ◊î◊û◊ß◊ï◊®◊ï◊™',
                total_deals: '◊°◊ö ◊î◊¢◊°◊ß◊ê◊ï◊™',
                total_revenue: '◊°◊ö ◊î◊î◊õ◊†◊°◊ï◊™',
                average_deal: '◊¢◊°◊ß◊î ◊û◊û◊ï◊¶◊¢◊™',
                conversion_rate: '◊©◊ô◊¢◊ï◊® ◊î◊û◊®◊î',
                closed_deals: '◊¢◊°◊ß◊ê◊ï◊™ ◊°◊í◊ï◊®◊ï◊™',
                qualified_leads: '◊ú◊ô◊ì◊ô◊ù ◊û◊ï◊°◊û◊õ◊ô◊ù',
                avg_activities: '◊û◊û◊ï◊¶◊¢ ◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™/◊¢◊°◊ß◊î',
                avg_days_close: '◊û◊û◊ï◊¶◊¢ ◊ô◊û◊ô◊ù ◊ú◊°◊í◊ô◊®◊î',
                total_installments: '◊°◊ö ◊î◊™◊©◊ú◊ï◊û◊ô◊ù',
                sales_trend: '◊û◊í◊û◊™ ◊û◊õ◊ô◊®◊ï◊™',
                sales_funnel: '◊û◊©◊§◊ö ◊û◊õ◊ô◊®◊ï◊™',
                top_performers: '◊û◊ï◊ë◊ô◊ú◊ô◊ù',
                deal_distribution: '◊î◊™◊§◊ú◊í◊ï◊™ ◊¢◊°◊ß◊ê◊ï◊™',
                traffic_sources: '◊†◊ô◊™◊ï◊ó ◊û◊ß◊ï◊®◊ï◊™ ◊™◊†◊ï◊¢◊î',
                payment_methods: '◊ê◊û◊¶◊¢◊ô ◊™◊©◊ú◊ï◊ù',
                recent_deals: '◊¢◊°◊ß◊ê◊ï◊™ ◊ê◊ó◊®◊ï◊†◊ï◊™',
                deal_name: '◊©◊ù ◊î◊¢◊°◊ß◊î',
                amount: '◊°◊õ◊ï◊ù',
                installments: '◊™◊©◊ú◊ï◊û◊ô◊ù',
                stage: '◊©◊ú◊ë',
                source: '◊û◊ß◊ï◊®',
                activities: '◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™',
                created: '◊†◊ï◊¶◊®',
                days_to_close: '◊ô◊û◊ô◊ù ◊ú◊°◊í◊ô◊®◊î',
                this_month: '◊î◊ó◊ï◊ì◊©',
                this_week: '◊î◊©◊ë◊ï◊¢',
                deals: '◊¢◊°◊ß◊ê◊ï◊™',
                avg_installments: '◊û◊û◊ï◊¶◊¢ ◊™◊©◊ú◊ï◊û◊ô◊ù',
                first_payment_rate: '◊©◊ô◊¢◊ï◊® ◊™◊©◊ú◊ï◊ù ◊®◊ê◊©◊ï◊ü',
                contacted_rate: '◊©◊ô◊¢◊ï◊® ◊ô◊¶◊ô◊®◊™ ◊ß◊©◊®',
                lead_sources: '◊û◊ß◊ï◊®◊ï◊™ ◊ú◊ô◊ì◊ô◊ù'
            }
        };

        let currentLang = 'en';
        let currentCurrency = 'ILS';
        const exchangeRate = 3.7; // ILS to USD exchange rate

        let allData = [];
        let filteredData = [];
        let charts = {};

        // Language switching
        function setLanguage(lang) {
            currentLang = lang;

            // Update button states
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update text direction
            if (lang === 'ar' || lang === 'he') {
                document.body.setAttribute('dir', 'rtl');
            } else {
                document.body.setAttribute('dir', 'ltr');
            }

            // Update translations
            updateTranslations();

            // Refresh dashboard if data is loaded
            if (allData.length > 0) {
                updateDashboard();
            }
        }

        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    element.textContent = translations[currentLang][key];
                }
            });

            // Update specific elements
            document.getElementById('dashboardTitle').textContent = translations[currentLang].dashboard_title;
            document.getElementById('uploadLabel').textContent = translations[currentLang].upload_label;
        }

        // Currency switching
        function setCurrency(currency) {
            currentCurrency = currency;

            // Update button states
            document.querySelectorAll('.currency-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Refresh dashboard if data is loaded
            if (allData.length > 0) {
                updateDashboard();
            }
        }

        function formatCurrency(amount) {
            const value = currentCurrency === 'USD' ? amount / exchangeRate : amount;
            const symbol = currentCurrency === 'USD' ? '$' : '‚Ç™';
            return `${symbol}${value.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
        }

        // Auto-load CSV if exists
        window.addEventListener('DOMContentLoaded', () => {
            fetch('export/20-sep/hubspot-crm-exports-all-deals-2025-09-20-1-enrich.csv')
                .then(response => response.text())
                .then(csvText => {
                    parseCSV(csvText);
                })
                .catch(() => {
                    console.log('Enhanced file not found, trying original...');
                    fetch('export/20-sep/hubspot-crm-exports-all-deals-2025-09-20.csv')
                        .then(response => response.text())
                        .then(csvText => {
                            parseCSV(csvText);
                        })
                        .catch(() => {
                            console.log('Files not found, waiting for user upload');
                        });
                });
        });

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `Loaded: ${file.name}`;
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                };
                reader.readAsText(file);
            }
        });

        function parseCSV(csvText) {
            Papa.parse(csvText, {
                header: true,
                complete: function(results) {
                    allData = results.data.filter(row => row['Deal Name']);
                    filteredData = [...allData];
                    initializeDashboard();
                }
            });
        }

        function initializeDashboard() {
            document.getElementById('filtersContainer').style.display = 'grid';
            document.getElementById('dashboardContent').style.display = 'block';

            populateFilters();
            updateDashboard();
            setupEventListeners();
        }

        function populateFilters() {
            // Populate managers
            const owners = [...new Set(allData.map(d => d['Deal owner']))].filter(Boolean);
            const ownerSelect = document.getElementById('dealOwner');
            ownerSelect.innerHTML = `<option value="">${translations[currentLang].all_managers}</option>`;
            owners.forEach(owner => {
                ownerSelect.innerHTML += `<option value="${owner}">${owner}</option>`;
            });

            // Populate stages
            const stages = [...new Set(allData.map(d => d['Deal Stage']))].filter(Boolean);
            const stageSelect = document.getElementById('dealStage');
            stageSelect.innerHTML = `<option value="">${translations[currentLang].all_stages}</option>`;
            stages.forEach(stage => {
                stageSelect.innerHTML += `<option value="${stage}">${stage}</option>`;
            });

            // Populate traffic sources
            const sources = [...new Set(allData.map(d => d['Original Traffic Source']))].filter(Boolean);
            const sourceSelect = document.getElementById('trafficSource');
            sourceSelect.innerHTML = `<option value="">${translations[currentLang].all_sources}</option>`;
            sources.forEach(source => {
                sourceSelect.innerHTML += `<option value="${source}">${source}</option>`;
            });

            // Set date ranges
            const dates = allData.map(d => new Date(d['Create Date'])).filter(d => !isNaN(d));
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                document.getElementById('dateFrom').value = minDate.toISOString().split('T')[0];
                document.getElementById('dateTo').value = maxDate.toISOString().split('T')[0];
            }
        }

        function setupEventListeners() {
            document.getElementById('dateFrom').addEventListener('change', filterData);
            document.getElementById('dateTo').addEventListener('change', filterData);
            document.getElementById('dealOwner').addEventListener('change', filterData);
            document.getElementById('dealStage').addEventListener('change', filterData);
            document.getElementById('trafficSource').addEventListener('change', filterData);
        }

        function filterData() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const owner = document.getElementById('dealOwner').value;
            const stage = document.getElementById('dealStage').value;
            const source = document.getElementById('trafficSource').value;

            filteredData = allData.filter(deal => {
                const dealDate = new Date(deal['Create Date']);

                if (dateFrom && dealDate < new Date(dateFrom)) return false;
                if (dateTo && dealDate > new Date(dateTo)) return false;
                if (owner && deal['Deal owner'] !== owner) return false;
                if (stage && deal['Deal Stage'] !== stage) return false;
                if (source && deal['Original Traffic Source'] !== source) return false;

                return true;
            });

            updateDashboard();
        }

        function updateDashboard() {
            updateMetrics();
            updateAdditionalStats();
            updateCharts();
            updateTable();
        }

        function updateMetrics() {
            const totalDeals = filteredData.length;
            const totalAmount = filteredData.reduce((sum, d) => sum + parseFloat(d['Amount'] || 0), 0);
            const avgDealSize = totalDeals > 0 ? totalAmount / totalDeals : 0;

            const closedWon = filteredData.filter(d =>
                d['Is Closed Won'] === 'true' ||
                (d['Deal Stage'] && d['Deal Stage'].toLowerCase().includes('closed won'))
            ).length;
            const conversionRate = totalDeals > 0 ? (closedWon / totalDeals * 100) : 0;

            // Calculate activities metrics
            const totalActivities = filteredData.reduce((sum, d) =>
                sum + parseInt(d['Number of Sales Activities'] || 0), 0
            );
            const avgActivities = totalDeals > 0 ? totalActivities / totalDeals : 0;

            // Calculate days to close
            const closedDeals = filteredData.filter(d => d['Days to close'] && d['Days to close'] !== '0.0');
            const avgDaysToClose = closedDeals.length > 0
                ? closedDeals.reduce((sum, d) => sum + parseFloat(d['Days to close']), 0) / closedDeals.length
                : 0;

            // Time-based metrics
            const today = new Date();
            const thisMonth = filteredData.filter(d => {
                const dealDate = new Date(d['Create Date']);
                return dealDate.getMonth() === today.getMonth() &&
                       dealDate.getFullYear() === today.getFullYear();
            });

            const metrics = [
                {
                    icon: 'üìä',
                    label: translations[currentLang].total_deals,
                    value: totalDeals.toLocaleString(),
                    change: `${thisMonth.length} ${translations[currentLang].this_month}`,
                    positive: true
                },
                {
                    icon: 'üí∞',
                    label: translations[currentLang].total_revenue,
                    value: formatCurrency(totalAmount),
                    change: formatCurrency(thisMonth.reduce((sum, d) => sum + parseFloat(d['Amount'] || 0), 0)) + ` ${translations[currentLang].this_month}`,
                    positive: true
                },
                {
                    icon: 'üìà',
                    label: translations[currentLang].average_deal,
                    value: formatCurrency(avgDealSize),
                    change: `${translations[currentLang].average_deal}`,
                    positive: true
                },
                {
                    icon: 'üéØ',
                    label: translations[currentLang].conversion_rate,
                    value: `${conversionRate.toFixed(1)}%`,
                    change: `${closedWon} ${translations[currentLang].closed_deals}`,
                    positive: conversionRate > 20
                },
                {
                    icon: 'üìû',
                    label: translations[currentLang].avg_activities,
                    value: avgActivities.toFixed(1),
                    change: `${totalActivities} total`,
                    positive: true
                },
                {
                    icon: '‚è±Ô∏è',
                    label: translations[currentLang].avg_days_close,
                    value: avgDaysToClose.toFixed(0) + ' days',
                    change: `${closedDeals.length} ${translations[currentLang].closed_deals}`,
                    positive: avgDaysToClose < 30
                }
            ];

            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-icon">${metric.icon}</div>
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-change ${metric.positive ? 'positive' : 'negative'}">
                        ${metric.positive ? '‚Üë' : '‚Üì'} ${metric.change}
                    </div>
                </div>
            `).join('');
        }

        function updateAdditionalStats() {
            // Calculate installments metrics - using Number of installments' months
            const dealsWithInstallments = filteredData.filter(d =>
                d['Number of installments\' months'] &&
                parseFloat(d['Number of installments\' months']) > 0
            );
            const totalInstallments = dealsWithInstallments.reduce((sum, d) =>
                sum + parseFloat(d['Number of installments\' months'] || 0), 0
            );
            const avgInstallments = dealsWithInstallments.length > 0
                ? totalInstallments / dealsWithInstallments.length
                : 0;

            // Calculate first payment metrics - count non-empty values
            const dealsWithFirstPayment = filteredData.filter(d =>
                d['1st payment'] && d['1st payment'].toString().trim() !== ''
            ).length;
            const firstPaymentRate = filteredData.length > 0
                ? (dealsWithFirstPayment / filteredData.length * 100)
                : 0;

            // Calculate contact metrics - check Number of times contacted
            const contactedDeals = filteredData.filter(d => {
                const timesContacted = parseFloat(d['Number of times contacted'] || 0);
                return timesContacted > 0;
            }).length;
            const contactRate = filteredData.length > 0
                ? (contactedDeals / filteredData.length * 100)
                : 0;

            const stats = [
                {
                    label: translations[currentLang].avg_installments,
                    value: avgInstallments.toFixed(1)
                },
                {
                    label: translations[currentLang].first_payment_rate,
                    value: `${firstPaymentRate.toFixed(0)}%`
                },
                {
                    label: translations[currentLang].contacted_rate,
                    value: `${contactRate.toFixed(0)}%`
                },
                {
                    label: translations[currentLang].total_installments,
                    value: totalInstallments.toLocaleString()
                }
            ];

            const statsRow = document.getElementById('additionalStats');
            statsRow.innerHTML = stats.map(stat => `
                <div class="stat-item">
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-value">${stat.value}</div>
                </div>
            `).join('');
        }

        function updateCharts() {
            updateSalesChart();
            updateFunnelChart();
            updateManagersChart();
            updateDealsDistribution();
            updateTrafficSourcesChart();
            updatePaymentMethodsChart();
        }

        function updateSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');

            const salesByDay = {};
            filteredData.forEach(deal => {
                const date = new Date(deal['Create Date']).toLocaleDateString();
                if (!salesByDay[date]) {
                    salesByDay[date] = { amount: 0, count: 0 };
                }
                salesByDay[date].amount += parseFloat(deal['Amount'] || 0);
                salesByDay[date].count++;
            });

            const sortedDates = Object.keys(salesByDay).sort((a, b) => new Date(a) - new Date(b));
            const last30Days = sortedDates.slice(-30);

            if (charts.sales) charts.sales.destroy();

            charts.sales = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30Days,
                    datasets: [{
                        label: translations[currentLang].total_revenue,
                        data: last30Days.map(date =>
                            currentCurrency === 'USD'
                                ? salesByDay[date].amount / exchangeRate
                                : salesByDay[date].amount
                        ),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateFunnelChart() {
            const stageOrder = ['Lead', 'Qualified', 'Proposal', 'Negotiation', 'Closed Won', 'Closed Lost'];
            const stageCount = {};

            filteredData.forEach(deal => {
                const stage = deal['Deal Stage'] || 'Unknown';
                stageCount[stage] = (stageCount[stage] || 0) + 1;
            });

            const stages = stageOrder
                .filter(stage => stageCount[stage] > 0)
                .map(stage => [stage, stageCount[stage]]);

            // Add any stages not in the predefined order
            Object.keys(stageCount).forEach(stage => {
                if (!stageOrder.includes(stage)) {
                    stages.push([stage, stageCount[stage]]);
                }
            });

            const maxCount = Math.max(...stages.map(s => s[1]));

            const funnelHTML = stages.map(([stage, count], index) => {
                const width = (count / maxCount * 100);
                const conversionRate = index > 0
                    ? ((count / stages[index - 1][1]) * 100).toFixed(1)
                    : 100;

                return `
                    <div class="funnel-stage">
                        <div class="funnel-label">${stage}</div>
                        <div class="funnel-bar" style="width: ${width}%">
                            <span>${count} ${translations[currentLang].deals}</span>
                            <div class="funnel-metrics">
                                <span>${conversionRate}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('funnelChart').innerHTML = funnelHTML;
        }

        function updateManagersChart() {
            const ctx = document.getElementById('managersChart').getContext('2d');

            const salesByManager = {};
            filteredData.forEach(deal => {
                const manager = deal['Deal owner'] || 'Unknown';
                if (!salesByManager[manager]) {
                    salesByManager[manager] = {
                        count: 0,
                        amount: 0,
                        activities: 0,
                        closedWon: 0
                    };
                }
                salesByManager[manager].count++;
                salesByManager[manager].amount += parseFloat(deal['Amount'] || 0);
                salesByManager[manager].activities += parseInt(deal['Number of Sales Activities'] || 0);
                if (deal['Is Closed Won'] === 'true') {
                    salesByManager[manager].closedWon++;
                }
            });

            // Show all managers, not just top 5
            const topManagers = Object.entries(salesByManager)
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, 10); // Increased to show up to 10 managers

            if (charts.managers) charts.managers.destroy();

            charts.managers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topManagers.map(m => m[0]),
                    datasets: [{
                        label: translations[currentLang].total_revenue,
                        data: topManagers.map(m =>
                            currentCurrency === 'USD'
                                ? m[1].amount / exchangeRate
                                : m[1].amount
                        ),
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateDealsDistribution() {
            const ctx = document.getElementById('dealsDistribution').getContext('2d');

            const ranges = currentCurrency === 'USD'
                ? [
                    { label: '< $300', min: 0, max: 1000 },
                    { label: '$300-600', min: 1000, max: 2000 },
                    { label: '$600-900', min: 2000, max: 3000 },
                    { label: '$900-1200', min: 3000, max: 4000 },
                    { label: '> $1200', min: 4000, max: Infinity }
                ]
                : [
                    { label: '< ‚Ç™1000', min: 0, max: 1000 },
                    { label: '‚Ç™1000-2000', min: 1000, max: 2000 },
                    { label: '‚Ç™2000-3000', min: 2000, max: 3000 },
                    { label: '‚Ç™3000-4000', min: 3000, max: 4000 },
                    { label: '> ‚Ç™4000', min: 4000, max: Infinity }
                ];

            const distribution = ranges.map(range => {
                return filteredData.filter(deal => {
                    const amount = parseFloat(deal['Amount'] || 0);
                    return amount >= range.min && amount < range.max;
                }).length;
            });

            if (charts.distribution) charts.distribution.destroy();

            charts.distribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ranges.map(r => r.label),
                    datasets: [{
                        data: distribution,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#a855f7',
                            '#d946ef',
                            '#ec4899'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateTrafficSourcesChart() {
            const ctx = document.getElementById('trafficChart').getContext('2d');

            const sourceMetrics = {};
            filteredData.forEach(deal => {
                const source = deal['Original Traffic Source'] || 'Unknown';
                if (!sourceMetrics[source]) {
                    sourceMetrics[source] = {
                        count: 0,
                        amount: 0,
                        conversion: 0
                    };
                }
                sourceMetrics[source].count++;
                sourceMetrics[source].amount += parseFloat(deal['Amount'] || 0);
                if (deal['Is Closed Won'] === 'true') {
                    sourceMetrics[source].conversion++;
                }
            });

            const sources = Object.entries(sourceMetrics)
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, 8);

            if (charts.traffic) charts.traffic.destroy();

            charts.traffic = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sources.map(s => s[0]),
                    datasets: [
                        {
                            label: translations[currentLang].total_revenue,
                            data: sources.map(s =>
                                currentCurrency === 'USD'
                                    ? s[1].amount / exchangeRate
                                    : s[1].amount
                            ),
                            backgroundColor: '#667eea',
                            yAxisID: 'y'
                        },
                        {
                            label: translations[currentLang].conversion_rate + ' (%)',
                            data: sources.map(s =>
                                s[1].count > 0 ? (s[1].conversion / s[1].count * 100) : 0
                            ),
                            type: 'line',
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePaymentMethodsChart() {
            const ctx = document.getElementById('paymentMethodsChart').getContext('2d');

            const paymentMethods = {};
            filteredData.forEach(deal => {
                const method = deal['payment method'] || deal['Payment Type'] || 'Not specified';
                if (!paymentMethods[method]) {
                    paymentMethods[method] = 0;
                }
                paymentMethods[method]++;
            });

            const methods = Object.entries(paymentMethods)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (charts.payments) charts.payments.destroy();

            charts.payments = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: methods.map(m => m[0]),
                    datasets: [{
                        data: methods.map(m => m[1]),
                        backgroundColor: [
                            '#10b981',
                            '#3b82f6',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateTable() {
            const tbody = document.getElementById('dealsTableBody');
            const recentDeals = filteredData
                .sort((a, b) => new Date(b['Last Modified Date']) - new Date(a['Last Modified Date']))
                .slice(0, 15);

            tbody.innerHTML = recentDeals.map(deal => {
                const stage = deal['Deal Stage'] || 'Unknown';
                let statusClass = 'lead';
                if (stage.toLowerCase().includes('qualified')) statusClass = 'qualified';
                if (stage.toLowerCase().includes('proposal')) statusClass = 'proposal';
                if (stage.toLowerCase().includes('closed won')) statusClass = 'closed-won';
                if (stage.toLowerCase().includes('closed lost')) statusClass = 'closed-lost';

                const amount = parseFloat(deal['Amount'] || 0);
                // Use correct fields for installments
                const installments = deal['Number of installments\' months'] && parseFloat(deal['Number of installments\' months']) > 0
                    ? Math.round(parseFloat(deal['Number of installments\' months']))
                    : '-';
                const activities = deal['Number of Sales Activities'] || '0';
                const daysToClose = deal['Days to close'] && parseFloat(deal['Days to close']) > 0
                    ? Math.round(parseFloat(deal['Days to close']))
                    : '-';
                const source = deal['Original Traffic Source'] || '-';

                return `
                    <tr>
                        <td>${deal['Deal Name']}</td>
                        <td>${deal['Deal owner']}</td>
                        <td>${formatCurrency(amount)}</td>
                        <td>${installments}</td>
                        <td><span class="status-badge ${statusClass}">${stage}</span></td>
                        <td>${source}</td>
                        <td>${activities}</td>
                        <td>${new Date(deal['Create Date']).toLocaleDateString()}</td>
                        <td>${daysToClose}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>