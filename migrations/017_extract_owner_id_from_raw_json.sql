/**
 * =====================================================================
 * Migration 017: Extract owner_id from raw_json
 * =====================================================================
 *
 * –ü–†–û–ë–õ–ï–ú–ê: hubspot_owner_id –∫–æ–ª–æ–Ω–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ 22%
 * –ü–†–ò–ß–ò–ù–ê: Sync script –Ω–µ –∏–∑–≤–ª–µ–∫–∞–ª owner_id –≤ –∫–æ–ª–æ–Ω–∫—É (—Ç–æ–ª—å–∫–æ –≤ raw_json)
 * –†–ï–®–ï–ù–ò–ï: –ò–∑–≤–ª–µ—á—å –∏–∑ raw_json.properties.hubspot_owner_id
 *
 * –ë–´–õ–û:
 *   hubspot_owner_id: 7,016 –∏–∑ 31,800 (22.1%)
 *
 * –°–¢–ê–ù–ï–¢:
 *   hubspot_owner_id: ~25,504 –∏–∑ 31,800 (80.2%)
 *
 * –í–†–ï–ú–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø: ~3-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ 31,800 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
 *
 * –í–ê–ñ–ù–û–°–¢–¨: –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ "–ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º" –≤ dashboard
 *
 * =====================================================================
 */

-- =====================================================================
-- STEP 1: –ò–∑–≤–ª–µ—á—å owner_id –∏–∑ raw_json
-- =====================================================================

UPDATE hubspot_contacts_raw
SET hubspot_owner_id = raw_json->'properties'->>'hubspot_owner_id'
WHERE hubspot_owner_id IS NULL
  AND raw_json->'properties'->>'hubspot_owner_id' IS NOT NULL;

-- ‚è±Ô∏è ~3-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ 31,800 –∑–∞–ø–∏—Å–µ–π
-- üìä –ó–∞–ø–æ–ª–Ω–∏—Ç ~14,501 owner_id (—Å 22% –¥–æ 80%)

-- =====================================================================
-- STEP 2: Verification
-- =====================================================================

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ owner_id –∑–∞–ø–æ–ª–Ω–µ–Ω–æ:
-- SELECT
--   COUNT(*) AS total_contacts,
--   COUNT(hubspot_owner_id) AS with_owner,
--   ROUND(COUNT(hubspot_owner_id)::numeric / COUNT(*) * 100, 1) AS percent
-- FROM hubspot_contacts_raw;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã:
-- SELECT hubspot_id, hubspot_owner_id, phone
-- FROM hubspot_contacts_raw
-- WHERE hubspot_owner_id IS NOT NULL
-- LIMIT 10;

-- =====================================================================
-- IMPACT
-- =====================================================================

-- –ü–æ—Å–ª–µ —ç—Ç–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:
--   ‚úÖ –§–∏–ª—å—Ç—Ä "–ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º" –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 80% –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
--   ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –±—É–¥—É—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
--   ‚úÖ Dashboard —Å—Ç–∞–Ω–µ—Ç –Ω–∞–º–Ω–æ–≥–æ —Ç–æ—á–Ω–µ–µ

-- =====================================================================
-- END OF MIGRATION 017
-- =====================================================================
