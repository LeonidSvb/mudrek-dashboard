/**
 * FETCH USEFUL FIELDS ONLY: Download only 167 useful HubSpot fields (not all 734)
 *
 * Usage:
 *   node src/hubspot/fetch-useful-fields.js
 *
 * Features:
 * - Fetches only fields with >= 20% fill rate (167 fields total)
 * - Skips 562 garbage fields (< 5% filled)
 * - TEST_MODE: limit to 50 records per object type
 * - Saves to data/ folder as JSON
 * - 68.9% smaller files (276 MB instead of 889 MB)
 */

import 'dotenv/config';
import { writeFileSync, mkdirSync, readFileSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// ========================================
// CONFIGURATION
// ========================================
const CONFIG = {
  // API Settings
  HUBSPOT_API_KEY: process.env.HUBSPOT_API_KEY,
  BASE_URL: 'https://api.hubapi.com',

  // Test mode: fetch only 50 records per type
  TEST_MODE: true,
  TEST_LIMIT: 50,

  // Production mode: fetch ALL records
  BATCH_SIZE: 100,

  // Output directory
  OUTPUT_DIR: join(__dirname, '../../data/hubspot-useful'),

  // Useful fields file (generated by analyze-full-data.js)
  USEFUL_FIELDS_FILE: join(__dirname, '../../data/hubspot-full/useful-fields.json'),

  // Objects to fetch
  FETCH_CONTACTS: true,
  FETCH_DEALS: true,
  FETCH_CALLS: true,

  // Associations to include
  ASSOCIATIONS: {
    contacts: ['deals', 'companies'],
    deals: ['contacts', 'companies', 'line_items'],
    calls: ['contacts', 'deals', 'companies']
  }
};

// ========================================
// LOAD USEFUL FIELDS (>= 20% fill rate)
// ========================================

// Load useful fields from JSON file generated by analyze-full-data.js
let USEFUL_FIELDS;
try {
  const usefulFieldsJson = readFileSync(CONFIG.USEFUL_FIELDS_FILE, 'utf8');
  USEFUL_FIELDS = JSON.parse(usefulFieldsJson);
  console.log('✓ Loaded useful fields from analysis');
  console.log(`  Contacts: ${USEFUL_FIELDS.contacts.length} fields`);
  console.log(`  Deals: ${USEFUL_FIELDS.deals.length} fields`);
  console.log(`  Calls: ${USEFUL_FIELDS.calls.length} fields\n`);
} catch (error) {
  console.error('✗ Failed to load useful fields file:', CONFIG.USEFUL_FIELDS_FILE);
  console.error('  Run this first: node scripts/discovery/analyze-full-data.js');
  process.exit(1);
}

// ========================================
// FUNCTIONS
// ========================================

/**
 * Fetch records from HubSpot with useful fields only
 */
async function fetchUsefulFields(objectType, associations = []) {
  const propertyNames = USEFUL_FIELDS[objectType];

  if (!propertyNames || propertyNames.length === 0) {
    throw new Error(`No useful fields defined for ${objectType}`);
  }

  let allRecords = [];
  let after = null;
  let hasMore = true;
  let pageCount = 0;

  console.log(`📡 Fetching ${objectType} with ${propertyNames.length} useful fields...`);

  if (CONFIG.TEST_MODE) {
    console.log(`⚠️  TEST MODE: Will fetch max ${CONFIG.TEST_LIMIT} records\n`);
  }

  while (hasMore) {
    pageCount++;

    // Build URL with useful properties only
    let url = `${CONFIG.BASE_URL}/crm/v3/objects/${objectType}?limit=${CONFIG.BATCH_SIZE}&archived=false`;

    // Add useful properties
    const propsParam = propertyNames.map(p => `properties=${p}`).join('&');
    url += `&${propsParam}`;

    // Add associations
    if (associations.length > 0) {
      const assocParam = associations.join(',');
      url += `&associations=${assocParam}`;
    }

    if (after) {
      url += `&after=${after}`;
    }

    try {
      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${CONFIG.HUBSPOT_API_KEY}`,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HubSpot API error ${response.status}: ${errorText}`);
      }

      const data = await response.json();
      allRecords = allRecords.concat(data.results);

      // Progress
      const propertiesCount = data.results[0]?.properties ? Object.keys(data.results[0].properties).length : 0;
      console.log(`  → Page ${pageCount}: ${data.results.length} records (${propertiesCount} properties each, total: ${allRecords.length})`);

      // Check if we should continue
      if (data.paging?.next) {
        after = data.paging.next.after;

        // Stop if TEST_MODE and reached limit
        if (CONFIG.TEST_MODE && allRecords.length >= CONFIG.TEST_LIMIT) {
          console.log(`✓ Reached TEST_LIMIT (${CONFIG.TEST_LIMIT}), stopping...\n`);
          hasMore = false;
        }
      } else {
        hasMore = false;
      }
    } catch (error) {
      console.error(`✗ Failed to fetch ${objectType} page ${pageCount}:`, error.message);
      throw error;
    }
  }

  // Truncate to TEST_LIMIT if needed
  if (CONFIG.TEST_MODE && allRecords.length > CONFIG.TEST_LIMIT) {
    allRecords = allRecords.slice(0, CONFIG.TEST_LIMIT);
  }

  // Summary
  const sampleRecord = allRecords[0];
  if (sampleRecord) {
    const propertiesCount = Object.keys(sampleRecord.properties || {}).length;
    const hasAssociations = !!sampleRecord.associations;

    console.log(`✓ Total ${objectType}: ${allRecords.length}`);
    console.log(`✓ Properties per record: ${propertiesCount}`);
    console.log(`✓ Has associations: ${hasAssociations ? 'YES' : 'NO'}\n`);
  }

  return allRecords;
}

/**
 * Save data to JSON file
 */
function saveToJSON(filename, data) {
  const filepath = join(CONFIG.OUTPUT_DIR, filename);

  console.log(`💾 Saving to ${filepath}...`);

  // Create directory if doesn't exist
  mkdirSync(CONFIG.OUTPUT_DIR, { recursive: true });

  // Write JSON file
  writeFileSync(filepath, JSON.stringify(data, null, 2));

  const sizeMB = (JSON.stringify(data).length / 1024 / 1024).toFixed(2);
  console.log(`✓ Saved ${filename} (${sizeMB} MB)\n`);
}

/**
 * Main function
 */
async function fetchAll() {
  console.log('╔═══════════════════════════════════════════╗');
  console.log('║   FETCH HUBSPOT USEFUL FIELDS TO JSON    ║');
  console.log('╚═══════════════════════════════════════════╝\n');

  console.log('📋 Configuration:');
  console.log(`   TEST_MODE: ${CONFIG.TEST_MODE ? `ON (${CONFIG.TEST_LIMIT} records max)` : 'OFF (fetch ALL)'}`);
  console.log(`   Fetch Contacts: ${CONFIG.FETCH_CONTACTS} (${USEFUL_FIELDS.contacts.length} fields)`);
  console.log(`   Fetch Deals: ${CONFIG.FETCH_DEALS} (${USEFUL_FIELDS.deals.length} fields)`);
  console.log(`   Fetch Calls: ${CONFIG.FETCH_CALLS} (${USEFUL_FIELDS.calls.length} fields)`);
  console.log(`   Total useful fields: 167 (vs 734 total fields)`);
  console.log(`   Expected size reduction: 68.9%`);
  console.log(`   Output: ${CONFIG.OUTPUT_DIR}\n`);

  const startTime = Date.now();
  const results = {};

  try {
    // Fetch contacts
    if (CONFIG.FETCH_CONTACTS) {
      results.contacts = await fetchUsefulFields('contacts', CONFIG.ASSOCIATIONS.contacts);
      saveToJSON('contacts.json', results.contacts);
    }

    // Fetch deals
    if (CONFIG.FETCH_DEALS) {
      results.deals = await fetchUsefulFields('deals', CONFIG.ASSOCIATIONS.deals);
      saveToJSON('deals.json', results.deals);
    }

    // Fetch calls
    if (CONFIG.FETCH_CALLS) {
      results.calls = await fetchUsefulFields('calls', CONFIG.ASSOCIATIONS.calls);
      saveToJSON('calls.json', results.calls);
    }

    const duration = ((Date.now() - startTime) / 1000).toFixed(2);

    // Summary
    console.log('╔═══════════════════════════════════════════╗');
    console.log('║               SUMMARY                      ║');
    console.log('╚═══════════════════════════════════════════╝\n');

    if (results.contacts) {
      const sample = results.contacts[0];
      const propsCount = Object.keys(sample?.properties || {}).length;
      const hasAssoc = !!sample?.associations;
      console.log(`📊 CONTACTS:`);
      console.log(`   Count: ${results.contacts.length}`);
      console.log(`   Properties: ${propsCount} (vs 422 total)`);
      console.log(`   Has associations: ${hasAssoc}\n`);
    }

    if (results.deals) {
      const sample = results.deals[0];
      const propsCount = Object.keys(sample?.properties || {}).length;
      const hasAssoc = !!sample?.associations;
      console.log(`💼 DEALS:`);
      console.log(`   Count: ${results.deals.length}`);
      console.log(`   Properties: ${propsCount} (vs 215 total)`);
      console.log(`   Has associations: ${hasAssoc}\n`);
    }

    if (results.calls) {
      const sample = results.calls[0];
      const propsCount = Object.keys(sample?.properties || {}).length;
      const hasAssoc = !!sample?.associations;
      console.log(`📞 CALLS:`);
      console.log(`   Count: ${results.calls.length}`);
      console.log(`   Properties: ${propsCount} (vs 97 total)`);
      console.log(`   Has associations: ${hasAssoc}\n`);
    }

    console.log(`⏱️  Total duration: ${duration}s`);
    console.log(`\n✅ Data saved to: ${CONFIG.OUTPUT_DIR}`);
    console.log(`\n💾 Size reduction: ~68.9% (only useful fields)`);
    console.log(`\n💡 Next step: Check JSON files, then run upload-from-json.js`);

  } catch (error) {
    console.error('\n❌ Fetch failed:', error.message);
    throw error;
  }
}

// Run
fetchAll().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});
