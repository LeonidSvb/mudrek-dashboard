<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard Pro - Multilingual</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: direction 0.3s ease;
        }

        body[dir="rtl"] {
            font-family: 'Segoe UI', 'Arial', 'Tahoma', sans-serif;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: #333;
            font-size: 2.2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .language-switcher {
            display: flex;
            gap: 10px;
            background: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .lang-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: #f0f0f0;
        }

        .lang-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .currency-toggle {
            display: flex;
            gap: 5px;
            background: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .currency-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .currency-btn:hover {
            background: #f0f0f0;
        }

        .currency-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            color: #666;
            font-weight: 600;
            font-size: 14px;
        }

        .filter-group input, .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .metric-label {
            color: #666;
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            line-height: 1.2;
        }

        .metric-change {
            font-size: 13px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .metric-change.positive {
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .chart-card canvas {
            max-height: 300px !important;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .funnel-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 15px;
            max-height: 350px;
            overflow-y: auto;
        }

        .funnel-stage {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .funnel-bar {
            height: 40px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .funnel-bar:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .funnel-label {
            min-width: 140px;
            font-weight: 600;
            color: #333;
        }

        .funnel-metrics {
            display: flex;
            gap: 20px;
            color: white;
            font-size: 14px;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            letter-spacing: 0.3px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        [dir="rtl"] th {
            text-align: right;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-badge.lead {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.qualified {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.proposal {
            background: #e9d5ff;
            color: #6b21a8;
        }

        .status-badge.closed-won {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.closed-lost {
            background: #fee2e2;
            color: #991b1b;
        }

        .file-input-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px dashed #667eea;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s ease;
        }

        .file-input-label:hover {
            transform: scale(1.05);
        }

        #csvFile {
            display: none;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 20px;
            padding: 50px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        [dir="rtl"] .funnel-bar:hover {
            transform: translateX(-10px);
        }

        [dir="rtl"] .metric-change {
            flex-direction: row-reverse;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Time Presets */
        .time-presets {
            display: flex;
            gap: 10px;
            background: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            align-items: center;
        }

        .time-presets label {
            font-weight: 600;
            color: #666;
            margin-right: 15px;
        }

        .preset-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            color: #666;
        }

        .preset-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .preset-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        /* Forecast specific styles */
        .forecast-controls {
            display: flex;
            gap: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            align-items: center;
            flex-wrap: wrap;
        }

        .forecast-period-selector {
            display: flex;
            gap: 10px;
        }

        .forecast-info {
            background: #f8f9ff;
            border: 2px solid #e0e6ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .forecast-info h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .forecast-confidence {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1 id="dashboardTitle">📊 Sales Dashboard Pro</h1>
            <div class="controls">
                <div class="language-switcher">
                    <button class="lang-btn active" onclick="setLanguage('en')">EN</button>
                    <button class="lang-btn" onclick="setLanguage('ar')">AR</button>
                    <button class="lang-btn" onclick="setLanguage('he')">HE</button>
                </div>
                <div class="currency-toggle">
                    <button class="currency-btn active" onclick="setCurrency('ILS')">₪ ILS</button>
                    <button class="currency-btn" onclick="setCurrency('USD')">$ USD</button>
                </div>
            </div>
        </div>

        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('analytics')" data-i18n="tab_analytics">📊 Analytics</button>
            <button class="tab-btn" onclick="switchTab('forecasts')" data-i18n="tab_forecasts">🔮 Forecasts</button>
        </div>

        <div class="file-input-container">
            <label for="csvFile" class="file-input-label" id="uploadLabel">
                📂 Upload HubSpot CSV File
            </label>
            <input type="file" id="csvFile" accept=".csv">
            <div id="fileName" style="margin-top: 10px; color: #666;"></div>
        </div>

        <!-- Analytics Tab Content -->
        <div id="analyticsTab" class="tab-content active">
            <div class="time-presets" style="display: none;" id="timePresetsContainer">
                <label data-i18n="time_period">Time Period:</label>
                <button class="preset-btn active" onclick="setTimePreset('7d')" data-i18n="last_7_days">Last 7 Days</button>
                <button class="preset-btn" onclick="setTimePreset('30d')" data-i18n="last_30_days">Last 30 Days</button>
                <button class="preset-btn" onclick="setTimePreset('3m')" data-i18n="last_3_months">Last 3 Months</button>
                <button class="preset-btn" onclick="setTimePreset('12m')" data-i18n="last_12_months">Last 12 Months</button>
                <button class="preset-btn" onclick="setTimePreset('ytd')" data-i18n="year_to_date">Year to Date</button>
                <button class="preset-btn" onclick="setTimePreset('custom')" data-i18n="custom_range">Custom Range</button>
            </div>

            <div class="filters" style="display: none;" id="filtersContainer">
            <div class="filter-group">
                <label for="dateFrom" data-i18n="from_date">From Date:</label>
                <input type="date" id="dateFrom">
            </div>
            <div class="filter-group">
                <label for="dateTo" data-i18n="to_date">To Date:</label>
                <input type="date" id="dateTo">
            </div>
            <div class="filter-group">
                <label for="dealOwner" data-i18n="manager">Manager:</label>
                <select id="dealOwner">
                    <option value="" data-i18n="all_managers">All Managers</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="dealStage" data-i18n="deal_stage">Deal Stage:</label>
                <select id="dealStage">
                    <option value="" data-i18n="all_stages">All Stages</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="trafficSource" data-i18n="traffic_source">Traffic Source:</label>
                <select id="trafficSource">
                    <option value="" data-i18n="all_sources">All Sources</option>
                </select>
            </div>
        </div>

        <div id="dashboardContent" style="display: none;">
            <div class="metrics-grid" id="metricsGrid">
                <!-- Metrics will be added dynamically -->
            </div>

            <div class="stats-row" id="additionalStats">
                <!-- Additional stats will be added here -->
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title"><span>📈</span> <span data-i18n="sales_trend">Sales Trend</span></h3>
                    <canvas id="salesChart"></canvas>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><span>🎯</span> <span data-i18n="sales_funnel">Sales Funnel</span></h3>
                    <div id="funnelChart" class="funnel-container"></div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><span>👥</span> <span data-i18n="top_performers">Top Performers</span></h3>
                    <canvas id="managersChart"></canvas>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><span>📊</span> <span data-i18n="deal_distribution">Deal Distribution</span></h3>
                    <canvas id="dealsDistribution"></canvas>
                </div>

                <div class="chart-card full-width">
                    <h3 class="chart-title"><span>🌐</span> <span data-i18n="traffic_sources">Traffic Sources Analysis</span></h3>
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3 class="chart-title"><span>📋</span> <span data-i18n="recent_deals">Recent Deals</span></h3>
                <table id="dealsTable">
                    <thead>
                        <tr>
                            <th data-i18n="deal_name">Deal Name</th>
                            <th data-i18n="manager">Manager</th>
                            <th data-i18n="amount">Amount</th>
                            <th data-i18n="installments">Installments</th>
                            <th data-i18n="stage">Stage</th>
                            <th data-i18n="source">Source</th>
                            <th data-i18n="activities">Activities</th>
                            <th data-i18n="created">Created</th>
                            <th data-i18n="days_to_close">Days to Close</th>
                        </tr>
                    </thead>
                    <tbody id="dealsTableBody">
                        <!-- Rows will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Forecasts Tab Content -->
        <div id="forecastsTab" class="tab-content">
            <div class="forecast-controls">
                <div>
                    <label data-i18n="forecast_period">Forecast Period:</label>
                    <div class="forecast-period-selector">
                        <button class="preset-btn active" onclick="setForecastPeriod(30)" data-i18n="days_30">30 Days</button>
                        <button class="preset-btn" onclick="setForecastPeriod(60)" data-i18n="days_60">60 Days</button>
                        <button class="preset-btn" onclick="setForecastPeriod(90)" data-i18n="days_90">90 Days</button>
                    </div>
                </div>
                <div>
                    <label data-i18n="based_on">Based on:</label>
                    <div class="forecast-period-selector">
                        <button class="preset-btn active" onclick="setForecastBasis('trend')" data-i18n="historical_trend">Trend</button>
                        <button class="preset-btn" onclick="setForecastBasis('pipeline')" data-i18n="pipeline">Pipeline</button>
                        <button class="preset-btn" onclick="setForecastBasis('combined')" data-i18n="combined">Combined</button>
                    </div>
                </div>
            </div>

            <div class="forecast-info">
                <h4 data-i18n="forecast_accuracy">Forecast Accuracy</h4>
                <p data-i18n="forecast_description">Revenue predictions based on historical data and current pipeline with ±10-15% confidence interval</p>
                <span class="forecast-confidence" data-i18n="confidence_level">85% Confidence</span>
            </div>

            <div class="metrics-grid" id="forecastMetricsGrid">
                <!-- Forecast metrics will be added dynamically -->
            </div>

            <div class="charts-grid">
                <div class="chart-card full-width">
                    <h3 class="chart-title"><span>📈</span> <span data-i18n="revenue_forecast">Revenue Forecast</span></h3>
                    <canvas id="forecastChart"></canvas>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><span>📊</span> <span data-i18n="forecast_breakdown">Forecast Breakdown</span></h3>
                    <canvas id="forecastBreakdownChart"></canvas>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><span>💰</span> <span data-i18n="installment_forecast">Installment Forecast</span></h3>
                    <canvas id="installmentForecastChart"></canvas>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><span>🎯</span> <span data-i18n="pipeline_potential">Pipeline Potential</span></h3>
                    <canvas id="pipelinePotentialChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3 class="chart-title"><span>📋</span> <span data-i18n="forecast_details">Forecast Details</span></h3>
                <table id="forecastTable">
                    <thead>
                        <tr>
                            <th data-i18n="period">Period</th>
                            <th data-i18n="conservative">Conservative</th>
                            <th data-i18n="realistic">Realistic</th>
                            <th data-i18n="optimistic">Optimistic</th>
                            <th data-i18n="confidence">Confidence</th>
                            <th data-i18n="basis">Basis</th>
                        </tr>
                    </thead>
                    <tbody id="forecastTableBody">
                        <!-- Forecast details will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Translation dictionary
        const translations = {
            en: {
                dashboard_title: '📊 Sales Dashboard Pro',
                upload_label: '📂 Upload HubSpot CSV File',
                from_date: 'From Date:',
                to_date: 'To Date:',
                manager: 'Manager:',
                deal_stage: 'Deal Stage:',
                traffic_source: 'Traffic Source:',
                all_managers: 'All Managers',
                all_stages: 'All Stages',
                all_sources: 'All Sources',
                total_deals: 'Total Deals',
                total_revenue: 'Total Revenue',
                average_deal: 'Average Deal',
                conversion_rate: 'Conversion Rate',
                closed_deals: 'Closed Deals',
                qualified_leads: 'Qualified Leads',
                avg_activities: 'Avg Activities/Deal',
                avg_days_close: 'Avg Days to Close',
                total_installments: 'Total Installments',
                sales_trend: 'Sales Trend',
                sales_funnel: 'Sales Funnel',
                top_performers: 'Top Performers',
                deal_distribution: 'Deal Distribution',
                traffic_sources: 'Traffic Sources Analysis',
                payment_methods: 'Payment Methods',
                recent_deals: 'Recent Deals',
                deal_name: 'Deal Name',
                amount: 'Amount',
                installments: 'Installments',
                stage: 'Stage',
                source: 'Source',
                activities: 'Activities',
                created: 'Created',
                days_to_close: 'Days to Close',
                this_month: 'this month',
                this_week: 'this week',
                deals: 'deals',
                avg_installments: 'Avg Installments',
                first_payment_rate: 'First Payment Rate',
                contacted_rate: 'Contact Rate',
                lead_sources: 'Lead Sources',
                tab_analytics: '📊 Analytics',
                tab_forecasts: '🔮 Forecasts',
                time_period: 'Time Period:',
                last_7_days: 'Last 7 Days',
                last_30_days: 'Last 30 Days',
                last_3_months: 'Last 3 Months',
                last_12_months: 'Last 12 Months',
                year_to_date: 'Year to Date',
                custom_range: 'Custom Range',
                forecast_period: 'Forecast Period:',
                days_30: '30 Days',
                days_60: '60 Days',
                days_90: '90 Days',
                based_on: 'Based on:',
                historical_trend: 'Trend',
                pipeline: 'Pipeline',
                combined: 'Combined',
                forecast_accuracy: 'Forecast Accuracy',
                forecast_description: 'Revenue predictions based on historical data and current pipeline with ±10-15% confidence interval',
                confidence_level: '85% Confidence',
                revenue_forecast: 'Revenue Forecast',
                forecast_breakdown: 'Forecast Breakdown',
                installment_forecast: 'Installment Forecast',
                pipeline_potential: 'Pipeline Potential',
                forecast_details: 'Forecast Details',
                period: 'Period',
                conservative: 'Conservative',
                realistic: 'Realistic',
                optimistic: 'Optimistic',
                confidence: 'Confidence',
                basis: 'Basis'
            },
            ar: {
                dashboard_title: '📊 لوحة معلومات المبيعات',
                upload_label: '📂 تحميل ملف CSV من HubSpot',
                from_date: 'من تاريخ:',
                to_date: 'إلى تاريخ:',
                manager: 'المدير:',
                deal_stage: 'مرحلة الصفقة:',
                traffic_source: 'مصدر الزيارات:',
                all_managers: 'جميع المديرين',
                all_stages: 'جميع المراحل',
                all_sources: 'جميع المصادر',
                total_deals: 'إجمالي الصفقات',
                total_revenue: 'إجمالي الإيرادات',
                average_deal: 'متوسط الصفقة',
                conversion_rate: 'معدل التحويل',
                closed_deals: 'الصفقات المغلقة',
                qualified_leads: 'العملاء المؤهلون',
                avg_activities: 'متوسط الأنشطة/الصفقة',
                avg_days_close: 'متوسط أيام الإغلاق',
                total_installments: 'إجمالي الأقساط',
                sales_trend: 'اتجاه المبيعات',
                sales_funnel: 'قمع المبيعات',
                top_performers: 'أفضل الأداء',
                deal_distribution: 'توزيع الصفقات',
                traffic_sources: 'تحليل مصادر الزيارات',
                payment_methods: 'طرق الدفع',
                recent_deals: 'الصفقات الأخيرة',
                deal_name: 'اسم الصفقة',
                amount: 'المبلغ',
                installments: 'الأقساط',
                stage: 'المرحلة',
                source: 'المصدر',
                activities: 'الأنشطة',
                created: 'تاريخ الإنشاء',
                days_to_close: 'أيام للإغلاق',
                this_month: 'هذا الشهر',
                this_week: 'هذا الأسبوع',
                deals: 'صفقات',
                avg_installments: 'متوسط الأقساط',
                first_payment_rate: 'معدل الدفعة الأولى',
                contacted_rate: 'معدل الاتصال',
                lead_sources: 'مصادر العملاء',
                tab_analytics: '📊 التحليلات',
                tab_forecasts: '🔮 التوقعات',
                time_period: 'الفترة الزمنية:',
                last_7_days: 'آخر 7 أيام',
                last_30_days: 'آخر 30 يوم',
                last_3_months: 'آخر 3 أشهر',
                last_12_months: 'آخر 12 شهر',
                year_to_date: 'من بداية السنة',
                custom_range: 'فترة مخصصة',
                forecast_period: 'فترة التوقع:',
                days_30: '30 يوم',
                days_60: '60 يوم',
                days_90: '90 يوم',
                based_on: 'بناء على:',
                historical_trend: 'الاتجاه',
                pipeline: 'الخط الأنابيب',
                combined: 'مجتمع',
                forecast_accuracy: 'دقة التوقع',
                forecast_description: 'توقعات الإيرادات بناء على البيانات التاريخية والخط الأنابيب الحالي مع فترة ثقة ±10-15%',
                confidence_level: '85% ثقة',
                revenue_forecast: 'توقع الإيرادات',
                forecast_breakdown: 'تفصيل التوقع',
                installment_forecast: 'توقع الأقساط',
                pipeline_potential: 'إمكانيات الخط الأنابيب',
                forecast_details: 'تفاصيل التوقع',
                period: 'الفترة',
                conservative: 'متحفظ',
                realistic: 'واقعي',
                optimistic: 'متفائل',
                confidence: 'الثقة',
                basis: 'الأساس'
            },
            he: {
                dashboard_title: '📊 לוח מחוונים למכירות',
                upload_label: '📂 העלה קובץ CSV מ-HubSpot',
                from_date: 'מתאריך:',
                to_date: 'עד תאריך:',
                manager: 'מנהל:',
                deal_stage: 'שלב העסקה:',
                traffic_source: 'מקור תנועה:',
                all_managers: 'כל המנהלים',
                all_stages: 'כל השלבים',
                all_sources: 'כל המקורות',
                total_deals: 'סך העסקאות',
                total_revenue: 'סך ההכנסות',
                average_deal: 'עסקה ממוצעת',
                conversion_rate: 'שיעור המרה',
                closed_deals: 'עסקאות סגורות',
                qualified_leads: 'לידים מוסמכים',
                avg_activities: 'ממוצע פעילויות/עסקה',
                avg_days_close: 'ממוצע ימים לסגירה',
                total_installments: 'סך התשלומים',
                sales_trend: 'מגמת מכירות',
                sales_funnel: 'משפך מכירות',
                top_performers: 'מובילים',
                deal_distribution: 'התפלגות עסקאות',
                traffic_sources: 'ניתוח מקורות תנועה',
                payment_methods: 'אמצעי תשלום',
                recent_deals: 'עסקאות אחרונות',
                deal_name: 'שם העסקה',
                amount: 'סכום',
                installments: 'תשלומים',
                stage: 'שלב',
                source: 'מקור',
                activities: 'פעילויות',
                created: 'נוצר',
                days_to_close: 'ימים לסגירה',
                this_month: 'החודש',
                this_week: 'השבוע',
                deals: 'עסקאות',
                avg_installments: 'ממוצע תשלומים',
                first_payment_rate: 'שיעור תשלום ראשון',
                contacted_rate: 'שיעור יצירת קשר',
                lead_sources: 'מקורות לידים',
                tab_analytics: '📊 אנליטיקה',
                tab_forecasts: '🔮 תחזיות',
                time_period: 'תקופת זמן:',
                last_7_days: '7 ימים אחרונים',
                last_30_days: '30 ימים אחרונים',
                last_3_months: '3 חודשים אחרונים',
                last_12_months: '12 חודשים אחרונים',
                year_to_date: 'מתחילת השנה',
                custom_range: 'טווח מותאם',
                forecast_period: 'תקופת תחזית:',
                days_30: '30 ימים',
                days_60: '60 ימים',
                days_90: '90 ימים',
                based_on: 'מבוסס על:',
                historical_trend: 'מגמה',
                pipeline: 'צינור',
                combined: 'משולב',
                forecast_accuracy: 'דיוק תחזית',
                forecast_description: 'תחזיות הכנסות מבוססות על נתונים היסטוריים וצינור נוכחי עם רווח ביטחון ±10-15%',
                confidence_level: '85% ביטחון',
                revenue_forecast: 'תחזית הכנסות',
                forecast_breakdown: 'פירוק תחזית',
                installment_forecast: 'תחזית תשלומים',
                pipeline_potential: 'פוטנציאל צינור',
                forecast_details: 'פרטי תחזית',
                period: 'תקופה',
                conservative: 'שמרני',
                realistic: 'ריאלי',
                optimistic: 'אופטימי',
                confidence: 'ביטחון',
                basis: 'בסיס'
            }
        };

        let currentLang = 'en';
        let currentCurrency = 'ILS';
        const exchangeRate = 3.7; // ILS to USD exchange rate
        let currentTab = 'analytics';
        let currentTimePreset = '30d';
        let currentForecastPeriod = 30;
        let currentForecastBasis = 'trend';

        let allData = [];
        let filteredData = [];
        let charts = {};
        let forecastCharts = {};

        // Tab switching
        function switchTab(tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            // Find the clicked button more reliably
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.textContent.includes('Analytics') && tabName === 'analytics') {
                    btn.classList.add('active');
                } else if (btn.textContent.includes('Forecasts') && tabName === 'forecasts') {
                    btn.classList.add('active');
                }
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Update charts based on active tab
            if (allData.length > 0) {
                if (tabName === 'analytics') {
                    updateDashboard();
                } else if (tabName === 'forecasts') {
                    updateForecasts();
                }
            }
        }

        // Time preset switching
        function setTimePreset(preset, clickedButton = null) {
            currentTimePreset = preset;

            // Update preset buttons
            document.querySelectorAll('#timePresetsContainer .preset-btn').forEach(btn => btn.classList.remove('active'));

            // If called from click event, use event.target, otherwise find the button
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else if (typeof event !== 'undefined' && event.target) {
                event.target.classList.add('active');
            } else {
                // Find button by preset value
                document.querySelectorAll('#timePresetsContainer .preset-btn').forEach(btn => {
                    if (btn.getAttribute('onclick').includes(preset)) {
                        btn.classList.add('active');
                    }
                });
            }

            // Calculate date range
            const today = new Date();
            let fromDate, toDate = today;

            switch(preset) {
                case '7d':
                    fromDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case '30d':
                    fromDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case '3m':
                    fromDate = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000);
                    break;
                case '12m':
                    fromDate = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'ytd':
                    fromDate = new Date(today.getFullYear(), 0, 1);
                    break;
                case 'custom':
                    // Don't change dates for custom, let user pick
                    return;
            }

            if (fromDate) {
                document.getElementById('dateFrom').value = fromDate.toISOString().split('T')[0];
                document.getElementById('dateTo').value = toDate.toISOString().split('T')[0];
                filterData();
            }
        }

        // Forecast controls
        function setForecastPeriod(days) {
            currentForecastPeriod = days;

            // Update forecast period buttons - be more specific
            document.querySelectorAll('.forecast-controls .forecast-period-selector .preset-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(days.toString())) {
                    btn.classList.add('active');
                }
            });

            if (allData.length > 0) {
                updateForecasts();
            }
        }

        function setForecastBasis(basis) {
            currentForecastBasis = basis;

            // Update forecast basis buttons - find the right container
            const allContainers = document.querySelectorAll('.forecast-period-selector');
            allContainers.forEach(container => {
                const buttons = container.querySelectorAll('.preset-btn');
                buttons.forEach(btn => {
                    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes('setForecastBasis')) {
                        btn.classList.remove('active');
                        if (btn.getAttribute('onclick').includes(basis)) {
                            btn.classList.add('active');
                        }
                    }
                });
            });

            if (allData.length > 0) {
                updateForecasts();
            }
        }

        // Language switching
        function setLanguage(lang) {
            currentLang = lang;

            // Update button states
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update text direction
            if (lang === 'ar' || lang === 'he') {
                document.body.setAttribute('dir', 'rtl');
            } else {
                document.body.setAttribute('dir', 'ltr');
            }

            // Update translations
            updateTranslations();

            // Refresh dashboard if data is loaded
            if (allData.length > 0) {
                updateDashboard();
            }
        }

        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    element.textContent = translations[currentLang][key];
                }
            });

            // Update specific elements
            document.getElementById('dashboardTitle').textContent = translations[currentLang].dashboard_title;
            document.getElementById('uploadLabel').textContent = translations[currentLang].upload_label;
        }

        // Currency switching
        function setCurrency(currency) {
            currentCurrency = currency;

            // Update button states
            document.querySelectorAll('.currency-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Refresh dashboard if data is loaded
            if (allData.length > 0) {
                updateDashboard();
            }
        }

        function formatCurrency(amount) {
            const value = currentCurrency === 'USD' ? amount / exchangeRate : amount;
            const symbol = currentCurrency === 'USD' ? '$' : '₪';
            return `${symbol}${value.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
        }

        // Manual upload only - no auto-loading due to CORS
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard loaded. Please upload a CSV file to begin.');
        });

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `Loaded: ${file.name}`;
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                };
                reader.readAsText(file);
            }
        });

        function parseCSV(csvText, fileType = 'unknown') {
            console.log('Parsing CSV, file type:', fileType);
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('CSV parsed successfully:', results.data.length, 'rows');
                    allData = results.data.filter(row => row['Deal Name'] || row['fname']); // Support both formats
                    filteredData = [...allData];
                    console.log('Filtered data:', allData.length, 'rows');
                    initializeDashboard();
                },
                error: function(error) {
                    console.error('CSV parsing error:', error);
                    alert('Error parsing CSV file: ' + error.message);
                }
            });
        }

        function initializeDashboard() {
            console.log('Initializing dashboard...');
            document.getElementById('filtersContainer').style.display = 'grid';
            document.getElementById('timePresetsContainer').style.display = 'flex';

            // Check if we're in analytics tab
            if (currentTab === 'analytics') {
                document.getElementById('dashboardContent').style.display = 'block';
            }

            populateFilters();
            updateDashboard();
            updateForecasts(); // Ensure forecasts data is also initialized
            setupEventListeners();

            // Set default time preset without event
            currentTimePreset = '30d';
            document.querySelectorAll('#timePresetsContainer .preset-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes('30') || btn.getAttribute('onclick').includes('30d')) {
                    btn.classList.add('active');
                }
            });

            // Apply default date range
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];

            console.log('Dashboard initialized successfully');
        }

        function populateFilters() {
            // Populate managers
            const owners = [...new Set(allData.map(d => d['Deal owner']))].filter(Boolean);
            const ownerSelect = document.getElementById('dealOwner');
            ownerSelect.innerHTML = `<option value="">${translations[currentLang].all_managers}</option>`;
            owners.forEach(owner => {
                ownerSelect.innerHTML += `<option value="${owner}">${owner}</option>`;
            });

            // Populate stages
            const stages = [...new Set(allData.map(d => d['Deal Stage']))].filter(Boolean);
            const stageSelect = document.getElementById('dealStage');
            stageSelect.innerHTML = `<option value="">${translations[currentLang].all_stages}</option>`;
            stages.forEach(stage => {
                stageSelect.innerHTML += `<option value="${stage}">${stage}</option>`;
            });

            // Populate traffic sources
            const sources = [...new Set(allData.map(d => d['Original Traffic Source']))].filter(Boolean);
            const sourceSelect = document.getElementById('trafficSource');
            sourceSelect.innerHTML = `<option value="">${translations[currentLang].all_sources}</option>`;
            sources.forEach(source => {
                sourceSelect.innerHTML += `<option value="${source}">${source}</option>`;
            });

            // Set date ranges
            const dates = allData.map(d => new Date(d['Create Date'])).filter(d => !isNaN(d));
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                document.getElementById('dateFrom').value = minDate.toISOString().split('T')[0];
                document.getElementById('dateTo').value = maxDate.toISOString().split('T')[0];
            }
        }

        function setupEventListeners() {
            document.getElementById('dateFrom').addEventListener('change', filterData);
            document.getElementById('dateTo').addEventListener('change', filterData);
            document.getElementById('dealOwner').addEventListener('change', filterData);
            document.getElementById('dealStage').addEventListener('change', filterData);
            document.getElementById('trafficSource').addEventListener('change', filterData);
        }

        function filterData() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const owner = document.getElementById('dealOwner').value;
            const stage = document.getElementById('dealStage').value;
            const source = document.getElementById('trafficSource').value;

            filteredData = allData.filter(deal => {
                const dealDate = new Date(deal['Create Date']);

                if (dateFrom && dealDate < new Date(dateFrom)) return false;
                if (dateTo && dealDate > new Date(dateTo)) return false;
                if (owner && deal['Deal owner'] !== owner) return false;
                if (stage && deal['Deal Stage'] !== stage) return false;
                if (source && deal['Original Traffic Source'] !== source) return false;

                return true;
            });

            updateDashboard();
        }

        function updateDashboard() {
            updateMetrics();
            updateAdditionalStats();
            updateCharts();
            updateTable();
        }

        function updateMetrics() {
            const totalDeals = filteredData.length;
            const totalAmount = filteredData.reduce((sum, d) => sum + parseFloat(d['Amount'] || 0), 0);
            const avgDealSize = totalDeals > 0 ? totalAmount / totalDeals : 0;

            const closedWon = filteredData.filter(d =>
                d['Is Closed Won'] === 'true' ||
                (d['Deal Stage'] && d['Deal Stage'].toLowerCase().includes('closed won'))
            ).length;
            const conversionRate = totalDeals > 0 ? (closedWon / totalDeals * 100) : 0;

            // Calculate activities metrics
            const totalActivities = filteredData.reduce((sum, d) =>
                sum + parseInt(d['Number of Sales Activities'] || 0), 0
            );
            const avgActivities = totalDeals > 0 ? totalActivities / totalDeals : 0;

            // Calculate days to close
            const closedDeals = filteredData.filter(d => d['Days to close'] && d['Days to close'] !== '0.0');
            const avgDaysToClose = closedDeals.length > 0
                ? closedDeals.reduce((sum, d) => sum + parseFloat(d['Days to close']), 0) / closedDeals.length
                : 0;

            // Time-based metrics
            const today = new Date();
            const thisMonth = filteredData.filter(d => {
                const dealDate = new Date(d['Create Date']);
                return dealDate.getMonth() === today.getMonth() &&
                       dealDate.getFullYear() === today.getFullYear();
            });

            const metrics = [
                {
                    icon: '📊',
                    label: translations[currentLang].total_deals,
                    value: totalDeals.toLocaleString(),
                    change: `${thisMonth.length} ${translations[currentLang].this_month}`,
                    positive: true
                },
                {
                    icon: '💰',
                    label: translations[currentLang].total_revenue,
                    value: formatCurrency(totalAmount),
                    change: formatCurrency(thisMonth.reduce((sum, d) => sum + parseFloat(d['Amount'] || 0), 0)) + ` ${translations[currentLang].this_month}`,
                    positive: true
                },
                {
                    icon: '📈',
                    label: translations[currentLang].average_deal,
                    value: formatCurrency(avgDealSize),
                    change: `${translations[currentLang].average_deal}`,
                    positive: true
                },
                {
                    icon: '🎯',
                    label: translations[currentLang].conversion_rate,
                    value: `${conversionRate.toFixed(1)}%`,
                    change: `${closedWon} ${translations[currentLang].closed_deals}`,
                    positive: conversionRate > 20
                },
                {
                    icon: '📞',
                    label: translations[currentLang].avg_activities,
                    value: avgActivities.toFixed(1),
                    change: `${totalActivities} total`,
                    positive: true
                },
                {
                    icon: '⏱️',
                    label: translations[currentLang].avg_days_close,
                    value: avgDaysToClose.toFixed(0) + ' days',
                    change: `${closedDeals.length} ${translations[currentLang].closed_deals}`,
                    positive: avgDaysToClose < 30
                }
            ];

            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-icon">${metric.icon}</div>
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-change ${metric.positive ? 'positive' : 'negative'}">
                        ${metric.positive ? '↑' : '↓'} ${metric.change}
                    </div>
                </div>
            `).join('');
        }

        function updateAdditionalStats() {
            // Calculate installments metrics - using Number of installments' months
            const dealsWithInstallments = filteredData.filter(d =>
                d['Number of installments\' months'] &&
                parseFloat(d['Number of installments\' months']) > 0
            );
            const totalInstallments = dealsWithInstallments.reduce((sum, d) =>
                sum + parseFloat(d['Number of installments\' months'] || 0), 0
            );
            const avgInstallments = dealsWithInstallments.length > 0
                ? totalInstallments / dealsWithInstallments.length
                : 0;

            // Calculate first payment metrics - count non-empty values
            const dealsWithFirstPayment = filteredData.filter(d =>
                d['1st payment'] && d['1st payment'].toString().trim() !== ''
            ).length;
            const firstPaymentRate = filteredData.length > 0
                ? (dealsWithFirstPayment / filteredData.length * 100)
                : 0;

            // Calculate contact metrics - check Number of times contacted
            const contactedDeals = filteredData.filter(d => {
                const timesContacted = parseFloat(d['Number of times contacted'] || 0);
                return timesContacted > 0;
            }).length;
            const contactRate = filteredData.length > 0
                ? (contactedDeals / filteredData.length * 100)
                : 0;

            const stats = [
                {
                    label: translations[currentLang].avg_installments,
                    value: avgInstallments.toFixed(1)
                },
                {
                    label: translations[currentLang].first_payment_rate,
                    value: `${firstPaymentRate.toFixed(0)}%`
                },
                {
                    label: translations[currentLang].contacted_rate,
                    value: `${contactRate.toFixed(0)}%`
                },
                {
                    label: translations[currentLang].total_installments,
                    value: totalInstallments.toLocaleString()
                }
            ];

            const statsRow = document.getElementById('additionalStats');
            statsRow.innerHTML = stats.map(stat => `
                <div class="stat-item">
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-value">${stat.value}</div>
                </div>
            `).join('');
        }

        function updateCharts() {
            updateSalesChart();
            updateFunnelChart();
            updateManagersChart();
            updateDealsDistribution();
            updateTrafficSourcesChart();
        }

        function updateSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');

            const salesByDay = {};
            filteredData.forEach(deal => {
                const date = new Date(deal['Create Date']).toLocaleDateString();
                if (!salesByDay[date]) {
                    salesByDay[date] = { amount: 0, count: 0 };
                }
                salesByDay[date].amount += parseFloat(deal['Amount'] || 0);
                salesByDay[date].count++;
            });

            const sortedDates = Object.keys(salesByDay).sort((a, b) => new Date(a) - new Date(b));
            const last30Days = sortedDates.slice(-30);

            if (charts.sales) charts.sales.destroy();

            charts.sales = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30Days,
                    datasets: [{
                        label: translations[currentLang].total_revenue,
                        data: last30Days.map(date =>
                            currentCurrency === 'USD'
                                ? salesByDay[date].amount / exchangeRate
                                : salesByDay[date].amount
                        ),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateFunnelChart() {
            const stageOrder = ['Lead', 'Qualified', 'Proposal', 'Negotiation', 'Closed Won', 'Closed Lost'];
            const stageCount = {};

            filteredData.forEach(deal => {
                const stage = deal['Deal Stage'] || 'Unknown';
                stageCount[stage] = (stageCount[stage] || 0) + 1;
            });

            const stages = stageOrder
                .filter(stage => stageCount[stage] > 0)
                .map(stage => [stage, stageCount[stage]]);

            // Add any stages not in the predefined order
            Object.keys(stageCount).forEach(stage => {
                if (!stageOrder.includes(stage)) {
                    stages.push([stage, stageCount[stage]]);
                }
            });

            const maxCount = Math.max(...stages.map(s => s[1]));

            const funnelHTML = stages.map(([stage, count], index) => {
                const width = (count / maxCount * 100);
                const conversionRate = index > 0
                    ? ((count / stages[index - 1][1]) * 100).toFixed(1)
                    : 100;

                return `
                    <div class="funnel-stage">
                        <div class="funnel-label">${stage}</div>
                        <div class="funnel-bar" style="width: ${width}%">
                            <span>${count} ${translations[currentLang].deals}</span>
                            <div class="funnel-metrics">
                                <span>${conversionRate}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('funnelChart').innerHTML = funnelHTML;
        }

        function updateManagersChart() {
            const ctx = document.getElementById('managersChart').getContext('2d');

            const salesByManager = {};
            filteredData.forEach(deal => {
                const manager = deal['Deal owner'] || 'Unknown';
                if (!salesByManager[manager]) {
                    salesByManager[manager] = {
                        count: 0,
                        amount: 0,
                        activities: 0,
                        closedWon: 0
                    };
                }
                salesByManager[manager].count++;
                salesByManager[manager].amount += parseFloat(deal['Amount'] || 0);
                salesByManager[manager].activities += parseInt(deal['Number of Sales Activities'] || 0);
                if (deal['Is Closed Won'] === 'true') {
                    salesByManager[manager].closedWon++;
                }
            });

            // Show all managers, not just top 5
            const topManagers = Object.entries(salesByManager)
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, 10); // Increased to show up to 10 managers

            if (charts.managers) charts.managers.destroy();

            charts.managers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topManagers.map(m => m[0]),
                    datasets: [{
                        label: translations[currentLang].total_revenue,
                        data: topManagers.map(m =>
                            currentCurrency === 'USD'
                                ? m[1].amount / exchangeRate
                                : m[1].amount
                        ),
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateDealsDistribution() {
            const ctx = document.getElementById('dealsDistribution').getContext('2d');

            const ranges = currentCurrency === 'USD'
                ? [
                    { label: '< $300', min: 0, max: 1000 },
                    { label: '$300-600', min: 1000, max: 2000 },
                    { label: '$600-900', min: 2000, max: 3000 },
                    { label: '$900-1200', min: 3000, max: 4000 },
                    { label: '> $1200', min: 4000, max: Infinity }
                ]
                : [
                    { label: '< ₪1000', min: 0, max: 1000 },
                    { label: '₪1000-2000', min: 1000, max: 2000 },
                    { label: '₪2000-3000', min: 2000, max: 3000 },
                    { label: '₪3000-4000', min: 3000, max: 4000 },
                    { label: '> ₪4000', min: 4000, max: Infinity }
                ];

            const distribution = ranges.map(range => {
                return filteredData.filter(deal => {
                    const amount = parseFloat(deal['Amount'] || 0);
                    return amount >= range.min && amount < range.max;
                }).length;
            });

            if (charts.distribution) charts.distribution.destroy();

            charts.distribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ranges.map(r => r.label),
                    datasets: [{
                        data: distribution,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#a855f7',
                            '#d946ef',
                            '#ec4899'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateTrafficSourcesChart() {
            const ctx = document.getElementById('trafficChart').getContext('2d');

            const sourceMetrics = {};
            filteredData.forEach(deal => {
                const source = deal['Original Traffic Source'] || 'Unknown';
                if (!sourceMetrics[source]) {
                    sourceMetrics[source] = {
                        count: 0,
                        amount: 0,
                        conversion: 0
                    };
                }
                sourceMetrics[source].count++;
                sourceMetrics[source].amount += parseFloat(deal['Amount'] || 0);
                if (deal['Is Closed Won'] === 'true') {
                    sourceMetrics[source].conversion++;
                }
            });

            const sources = Object.entries(sourceMetrics)
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, 8);

            if (charts.traffic) charts.traffic.destroy();

            charts.traffic = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sources.map(s => s[0]),
                    datasets: [
                        {
                            label: translations[currentLang].total_revenue,
                            data: sources.map(s =>
                                currentCurrency === 'USD'
                                    ? s[1].amount / exchangeRate
                                    : s[1].amount
                            ),
                            backgroundColor: '#667eea',
                            yAxisID: 'y'
                        },
                        {
                            label: translations[currentLang].conversion_rate + ' (%)',
                            data: sources.map(s =>
                                s[1].count > 0 ? (s[1].conversion / s[1].count * 100) : 0
                            ),
                            type: 'line',
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }


        function updateTable() {
            const tbody = document.getElementById('dealsTableBody');
            const recentDeals = filteredData
                .sort((a, b) => new Date(b['Last Modified Date']) - new Date(a['Last Modified Date']))
                .slice(0, 15);

            tbody.innerHTML = recentDeals.map(deal => {
                const stage = deal['Deal Stage'] || 'Unknown';
                let statusClass = 'lead';
                if (stage.toLowerCase().includes('qualified')) statusClass = 'qualified';
                if (stage.toLowerCase().includes('proposal')) statusClass = 'proposal';
                if (stage.toLowerCase().includes('closed won')) statusClass = 'closed-won';
                if (stage.toLowerCase().includes('closed lost')) statusClass = 'closed-lost';

                const amount = parseFloat(deal['Amount'] || 0);
                // Use correct fields for installments
                const installments = deal['Number of installments\' months'] && parseFloat(deal['Number of installments\' months']) > 0
                    ? Math.round(parseFloat(deal['Number of installments\' months']))
                    : '-';
                const activities = deal['Number of Sales Activities'] || '0';
                const daysToClose = deal['Days to close'] && parseFloat(deal['Days to close']) > 0
                    ? Math.round(parseFloat(deal['Days to close']))
                    : '-';
                const source = deal['Original Traffic Source'] || '-';

                return `
                    <tr>
                        <td>${deal['Deal Name']}</td>
                        <td>${deal['Deal owner']}</td>
                        <td>${formatCurrency(amount)}</td>
                        <td>${installments}</td>
                        <td><span class="status-badge ${statusClass}">${stage}</span></td>
                        <td>${source}</td>
                        <td>${activities}</td>
                        <td>${new Date(deal['Create Date']).toLocaleDateString()}</td>
                        <td>${daysToClose}</td>
                    </tr>
                `;
            }).join('');
        }

        // Forecast functions
        function updateForecasts() {
            try {
                console.log('Updating forecasts...', 'Data length:', allData.length);
                if (allData.length === 0) {
                    console.warn('No data available for forecasting');
                    return;
                }
                updateForecastMetrics();
                updateForecastCharts();
                updateForecastTable();
                console.log('Forecasts updated successfully');
            } catch (error) {
                console.error('Error updating forecasts:', error);
            }
        }

        function updateForecastMetrics() {
            const forecast = calculateForecast();

            const metrics = [
                {
                    icon: '📈',
                    label: translations[currentLang].realistic || 'Realistic Forecast',
                    value: formatCurrency(forecast.realistic),
                    change: `${currentForecastPeriod} ${translations[currentLang]['days_' + currentForecastPeriod] || 'days'}`,
                    positive: true
                },
                {
                    icon: '🎯',
                    label: translations[currentLang].conservative || 'Conservative',
                    value: formatCurrency(forecast.conservative),
                    change: `${forecast.confidence}% confidence`,
                    positive: true
                },
                {
                    icon: '🚀',
                    label: translations[currentLang].optimistic || 'Optimistic',
                    value: formatCurrency(forecast.optimistic),
                    change: `Best case scenario`,
                    positive: true
                },
                {
                    icon: '💰',
                    label: 'Expected Installments',
                    value: formatCurrency(forecast.installments),
                    change: `From existing deals`,
                    positive: true
                }
            ];

            const forecastMetricsGrid = document.getElementById('forecastMetricsGrid');
            forecastMetricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-icon">${metric.icon}</div>
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-change ${metric.positive ? 'positive' : 'negative'}">
                        ${metric.positive ? '↑' : '↓'} ${metric.change}
                    </div>
                </div>
            `).join('');
        }

        function calculateForecast() {
            const historical = calculateHistoricalTrend();
            const pipeline = calculatePipelineForecast();
            const installments = calculateInstallmentForecast();

            console.log('Forecast calculations:', { historical, pipeline, installments, basis: currentForecastBasis });

            let forecast = {};

            switch(currentForecastBasis) {
                case 'trend':
                    forecast = {
                        conservative: historical * 0.85,
                        realistic: historical,
                        optimistic: historical * 1.15,
                        confidence: 75
                    };
                    break;
                case 'pipeline':
                    forecast = {
                        conservative: pipeline * 0.8,
                        realistic: pipeline,
                        optimistic: pipeline * 1.2,
                        confidence: 80
                    };
                    break;
                case 'combined':
                    const combined = (historical * 0.6) + (pipeline * 0.4);
                    forecast = {
                        conservative: combined * 0.85,
                        realistic: combined,
                        optimistic: combined * 1.15,
                        confidence: 85
                    };
                    break;
            }

            forecast.installments = installments;
            return forecast;
        }

        function calculateHistoricalTrend() {
            // Get revenue data for trend analysis
            const days = currentForecastPeriod;
            const historicalDays = Math.min(days * 2, 180); // Use up to 180 days of history

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - historicalDays);

            const historicalData = allData.filter(deal => {
                const dealDate = new Date(deal['Create Date']);
                return dealDate >= cutoffDate;
            });

            if (historicalData.length === 0) return 0;

            // Calculate daily average and project forward
            const totalRevenue = historicalData.reduce((sum, deal) =>
                sum + parseFloat(deal['Amount'] || 0), 0
            );

            const dailyAverage = totalRevenue / historicalDays;
            return dailyAverage * days;
        }

        function calculatePipelineForecast() {
            // Calculate expected revenue from open deals
            const openDeals = allData.filter(deal =>
                !deal['Is Closed Won'] || deal['Is Closed Won'] !== 'true'
            );

            let expectedRevenue = 0;

            openDeals.forEach(deal => {
                const amount = parseFloat(deal['Amount'] || 0);
                const stage = deal['Deal Stage'];

                // Estimate conversion probability based on stage
                let probability = 0.1; // Default for leads
                if (stage && stage.toLowerCase().includes('qualified')) probability = 0.3;
                if (stage && stage.toLowerCase().includes('proposal')) probability = 0.5;
                if (stage && stage.toLowerCase().includes('negotiation')) probability = 0.7;

                expectedRevenue += amount * probability;
            });

            return expectedRevenue;
        }

        function calculateInstallmentForecast() {
            // Calculate expected revenue from existing installment plans
            const dealsWithInstallments = allData.filter(deal =>
                deal['Number of installments\' months'] &&
                parseFloat(deal['Number of installments\' months']) > 1
            );

            let installmentRevenue = 0;
            const forecastDays = currentForecastPeriod;

            dealsWithInstallments.forEach(deal => {
                const totalAmount = parseFloat(deal['Amount'] || 0);
                const installments = parseFloat(deal['Number of installments\' months'] || 1);
                const monthlyPayment = totalAmount / installments;

                // Estimate how many payments will occur in forecast period
                const monthsInPeriod = forecastDays / 30;
                const paymentsInPeriod = Math.min(monthsInPeriod, installments);

                installmentRevenue += monthlyPayment * paymentsInPeriod;
            });

            return installmentRevenue;
        }

        function updateForecastCharts() {
            updateForecastChart();
            updateForecastBreakdownChart();
            updateInstallmentForecastChart();
            updatePipelinePotentialChart();
        }

        function updateForecastChart() {
            const ctx = document.getElementById('forecastChart').getContext('2d');

            // Historical data for the last 30 days
            const last30Days = [];
            const today = new Date();
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                const dayData = allData.filter(deal => {
                    const dealDate = new Date(deal['Create Date']);
                    return dealDate.toDateString() === date.toDateString();
                });
                const dayRevenue = dayData.reduce((sum, deal) => sum + parseFloat(deal['Amount'] || 0), 0);
                last30Days.push({
                    date: date.toLocaleDateString(),
                    revenue: currentCurrency === 'USD' ? dayRevenue / exchangeRate : dayRevenue
                });
            }

            // Forecast data
            const forecast = calculateForecast();
            const forecastDays = [];
            const dailyForecast = forecast.realistic / currentForecastPeriod;

            for (let i = 1; i <= currentForecastPeriod; i++) {
                const date = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
                forecastDays.push({
                    date: date.toLocaleDateString(),
                    revenue: currentCurrency === 'USD' ? dailyForecast / exchangeRate : dailyForecast,
                    conservative: currentCurrency === 'USD' ? (forecast.conservative / currentForecastPeriod) / exchangeRate : forecast.conservative / currentForecastPeriod,
                    optimistic: currentCurrency === 'USD' ? (forecast.optimistic / currentForecastPeriod) / exchangeRate : forecast.optimistic / currentForecastPeriod
                });
            }

            if (forecastCharts.main) forecastCharts.main.destroy();

            forecastCharts.main = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [...last30Days.map(d => d.date), ...forecastDays.map(d => d.date)],
                    datasets: [
                        {
                            label: 'Historical Revenue',
                            data: [...last30Days.map(d => d.revenue), ...new Array(forecastDays.length).fill(null)],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Forecast',
                            data: [...new Array(last30Days.length).fill(null), ...forecastDays.map(d => d.revenue)],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Conservative',
                            data: [...new Array(last30Days.length).fill(null), ...forecastDays.map(d => d.conservative)],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.05)',
                            borderDash: [2, 2],
                            tension: 0.4,
                            fill: '+1'
                        },
                        {
                            label: 'Optimistic',
                            data: [...new Array(last30Days.length).fill(null), ...forecastDays.map(d => d.optimistic)],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.05)',
                            borderDash: [2, 2],
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateForecastBreakdownChart() {
            const ctx = document.getElementById('forecastBreakdownChart').getContext('2d');

            const historical = calculateHistoricalTrend();
            const pipeline = calculatePipelineForecast();
            const installments = calculateInstallmentForecast();

            if (forecastCharts.breakdown) forecastCharts.breakdown.destroy();

            forecastCharts.breakdown = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Historical Trend', 'Pipeline', 'Installments'],
                    datasets: [{
                        data: [
                            currentCurrency === 'USD' ? historical / exchangeRate : historical,
                            currentCurrency === 'USD' ? pipeline / exchangeRate : pipeline,
                            currentCurrency === 'USD' ? installments / exchangeRate : installments
                        ],
                        backgroundColor: ['#667eea', '#10b981', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateInstallmentForecastChart() {
            const ctx = document.getElementById('installmentForecastChart').getContext('2d');

            // Calculate installment revenue by month
            const monthlyInstallments = [];
            for (let i = 1; i <= Math.ceil(currentForecastPeriod / 30); i++) {
                const monthRevenue = calculateInstallmentForecast() / Math.ceil(currentForecastPeriod / 30);
                monthlyInstallments.push(currentCurrency === 'USD' ? monthRevenue / exchangeRate : monthRevenue);
            }

            if (forecastCharts.installments) forecastCharts.installments.destroy();

            forecastCharts.installments = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyInstallments.map((_, i) => `Month ${i + 1}`),
                    datasets: [{
                        label: 'Expected Installments',
                        data: monthlyInstallments,
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePipelinePotentialChart() {
            const ctx = document.getElementById('pipelinePotentialChart').getContext('2d');

            // Group open deals by stage
            const stageRevenue = {};
            const openDeals = allData.filter(deal =>
                !deal['Is Closed Won'] || deal['Is Closed Won'] !== 'true'
            );

            openDeals.forEach(deal => {
                const stage = deal['Deal Stage'] || 'Unknown';
                const amount = parseFloat(deal['Amount'] || 0);
                if (!stageRevenue[stage]) stageRevenue[stage] = 0;
                stageRevenue[stage] += amount;
            });

            const stages = Object.keys(stageRevenue);
            const revenues = stages.map(stage =>
                currentCurrency === 'USD' ? stageRevenue[stage] / exchangeRate : stageRevenue[stage]
            );

            if (forecastCharts.pipeline) forecastCharts.pipeline.destroy();

            forecastCharts.pipeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stages,
                    datasets: [{
                        label: 'Pipeline Value',
                        data: revenues,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateForecastTable() {
            const tbody = document.getElementById('forecastTableBody');
            const forecast = calculateForecast();

            const periods = [];
            if (currentForecastPeriod >= 30) periods.push('Next 30 days');
            if (currentForecastPeriod >= 60) periods.push('Next 60 days');
            if (currentForecastPeriod >= 90) periods.push('Next 90 days');

            tbody.innerHTML = periods.map((period, index) => {
                const factor = (index + 1) / periods.length;
                return `
                    <tr>
                        <td>${period}</td>
                        <td>${formatCurrency(forecast.conservative * factor)}</td>
                        <td>${formatCurrency(forecast.realistic * factor)}</td>
                        <td>${formatCurrency(forecast.optimistic * factor)}</td>
                        <td>${forecast.confidence}%</td>
                        <td>${currentForecastBasis.charAt(0).toUpperCase() + currentForecastBasis.slice(1)}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>