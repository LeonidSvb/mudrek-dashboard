/**
 * =====================================================================
 * Migration 016: Extract Email from raw_json
 * =====================================================================
 *
 * –ü–†–û–ë–õ–ï–ú–ê: email –∫–æ–ª–æ–Ω–∫–∞ –ø—É—Å—Ç–∞—è (0% –¥–∞–Ω–Ω—ã—Ö)
 * –ü–†–ò–ß–ò–ù–ê: –ü—Ä–∏ sync –Ω–µ –∏–∑–≤–ª–µ–∫–ª–∏ email –∏–∑ HubSpot
 * –†–ï–®–ï–ù–ò–ï: –ò–∑–≤–ª–µ—á—å –∏–∑ raw_json.properties.hs_full_name_or_email
 *
 * –ë–´–õ–û:
 *   email: NULL (0 –∏–∑ 31,800)
 *
 * –°–¢–ê–ù–ï–¢:
 *   email: –∑–∞–ø–æ–ª–Ω–µ–Ω (~20% –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–º–µ—é—Ç email –≤ HubSpot)
 *
 * –í–†–ï–ú–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø: ~3-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ 31,800 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
 *
 * –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –¢–æ–ª—å–∫–æ UPDATE, –Ω–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è
 *
 * =====================================================================
 */

-- =====================================================================
-- STEP 1: –ò–∑–≤–ª–µ—á—å email –∏–∑ raw_json
-- =====================================================================

UPDATE hubspot_contacts_raw
SET email = raw_json->'properties'->>'hs_full_name_or_email'
WHERE email IS NULL
  AND raw_json->'properties'->>'hs_full_name_or_email' IS NOT NULL;

-- ‚è±Ô∏è ~3-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ 31,800 –∑–∞–ø–∏—Å–µ–π
-- üìä –ó–∞–ø–æ–ª–Ω–∏—Ç ~6,000-7,000 emails (20% –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤)

-- =====================================================================
-- STEP 2: Verification
-- =====================================================================

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ email –∑–∞–ø–æ–ª–Ω–µ–Ω–æ:
-- SELECT
--   COUNT(*) AS total_contacts,
--   COUNT(email) AS with_email,
--   ROUND(COUNT(email)::numeric / COUNT(*) * 100, 1) AS percent
-- FROM hubspot_contacts_raw;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã:
-- SELECT hubspot_id, email, phone
-- FROM hubspot_contacts_raw
-- WHERE email IS NOT NULL
-- LIMIT 10;

-- =====================================================================
-- ROLLBACK (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –æ–±—Ä–∞—Ç–Ω–æ)
-- =====================================================================

-- –û—á–∏—Å—Ç–∏—Ç—å email –∫–æ–ª–æ–Ω–∫—É:
-- UPDATE hubspot_contacts_raw SET email = NULL;

-- =====================================================================
-- NOTES
-- =====================================================================

-- –ü–æ—á–µ–º—É –Ω–µ –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–º–µ—é—Ç email?
--   - –í HubSpot CRM –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –¢–û–õ–¨–ö–û —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º
--   - Email –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ
--   - ~20% –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–º–µ—é—Ç email, ~80% —Ç–æ–ª—å–∫–æ —Ç–µ–ª–µ—Ñ–æ–Ω
--   - –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ (cold calling)

-- –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?
--   - Email —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∫–æ–ª–æ–Ω–∫–µ –¥–ª—è UI
--   - –î–ª—è –º–µ—Ç—Ä–∏–∫ email –ù–ï –Ω—É–∂–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ–º phone –¥–ª—è matching)
--   - –í—Å—ë –≥–æ—Ç–æ–≤–æ!

-- =====================================================================
-- END OF MIGRATION 016
-- =====================================================================
