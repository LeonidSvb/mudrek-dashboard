/**
 * =====================================================================
 * Migration 018: Clean Invalid Emails
 * =====================================================================
 *
 * –ü–†–û–ë–õ–ï–ú–ê: email –∫–æ–ª–æ–Ω–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç MIX –∏–∑ emails –∏ –∏–º–µ–Ω (95.1% –∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
 * –ü–†–ò–ß–ò–ù–ê: –ò–∑–≤–ª–µ–∫–ª–∏ –∏–∑ raw_json.properties.hs_full_name_or_email
 *          –≠—Ç–æ HubSpot auto-generated –ø–æ–ª–µ: email –ò–õ–ò firstname+lastname
 * –†–ï–ó–£–õ–¨–¢–ê–¢: –ü—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ regex 100% –∑–∞–ø–∏—Å–µ–π = –∏–º–µ–Ω–∞, –Ω–µ emails
 *
 * –ü–†–ò–ú–ï–†–´ –ù–ï–í–ê–õ–ò–î–ù–´–• –î–ê–ù–ù–´–•:
 *   - "Deiaa"
 *   - "Maha"
 *   - "Rasha"
 *   - "Naseem"
 *
 * –ü–†–ò–ú–ï–†–´ –í–ê–õ–ò–î–ù–´–•:
 *   - "abeer.majadly@gmail.com"
 *   - "naseem_b87@hotmail.com"
 *
 * –ë–´–õ–û:
 *   email: 30,256 –∏–∑ 31,800 (95.1%) - MIX –∏–º–µ–Ω –∏ emails
 *
 * –°–¢–ê–ù–ï–¢:
 *   email: ~6,000-7,000 –∏–∑ 31,800 (20%) - —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ emails
 *   –û—Å—Ç–∞–ª—å–Ω—ã–µ: NULL (–∏–º–µ–Ω–∞ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ raw_json)
 *
 * –í–†–ï–ú–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø: ~3-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ 31,800 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
 *
 * –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –î–∞–Ω–Ω—ã–µ –ù–ï —É–¥–∞–ª—è—é—Ç—Å—è, original –≤ raw_json
 *
 * =====================================================================
 */

-- =====================================================================
-- STEP 1: –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ emails
-- =====================================================================

UPDATE hubspot_contacts_raw
SET email = CASE
  WHEN email ~ '^[^\s@]+@[^\s@]+\.[^\s@]+$'  -- PostgreSQL regex –¥–ª—è email
  THEN email
  ELSE NULL
END
WHERE email IS NOT NULL;

-- ‚è±Ô∏è ~3-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ 31,800 –∑–∞–ø–∏—Å–µ–π
-- üìä –û—á–∏—Å—Ç–∏—Ç ~24,000 –∏–º–µ–Ω, –æ—Å—Ç–∞–≤–∏—Ç ~6,000 –≤–∞–ª–∏–¥–Ω—ã—Ö emails

-- =====================================================================
-- STEP 2: Verification
-- =====================================================================

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã—Ö email –æ—Å—Ç–∞–ª–æ—Å—å:
-- SELECT
--   COUNT(*) AS total_contacts,
--   COUNT(email) AS with_valid_email,
--   ROUND(COUNT(email)::numeric / COUNT(*) * 100, 1) AS percent
-- FROM hubspot_contacts_raw;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –≤–∞–ª–∏–¥–Ω—ã—Ö emails:
-- SELECT hubspot_id, email, phone
-- FROM hubspot_contacts_raw
-- WHERE email IS NOT NULL
-- LIMIT 20;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω—ã (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤):
-- SELECT hubspot_id, email
-- FROM hubspot_contacts_raw
-- WHERE email IS NOT NULL
--   AND email !~ '^[^\s@]+@[^\s@]+\.[^\s@]+$'
-- LIMIT 10;

-- =====================================================================
-- ROLLBACK (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –æ–±—Ä–∞—Ç–Ω–æ)
-- =====================================================================

-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ raw_json:
-- UPDATE hubspot_contacts_raw
-- SET email = raw_json->'properties'->>'hs_full_name_or_email'
-- WHERE email IS NULL
--   AND raw_json->'properties'->>'hs_full_name_or_email' IS NOT NULL;

-- =====================================================================
-- NOTES
-- =====================================================================

-- –ü–æ—á–µ–º—É –≤ email –∫–æ–ª–æ–Ω–∫–µ –±—ã–ª–∏ –∏–º–µ–Ω–∞?
--   - HubSpot –ø–æ–ª–µ hs_full_name_or_email = auto-generated fallback
--   - –ï—Å–ª–∏ email –ø—É—Å—Ç–æ–π ‚Üí HubSpot –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç firstname + lastname
--   - –ö–æ–º–∞–Ω–¥–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç email –ø–æ–ª–µ –≤ HubSpot (—Ç–æ–ª—å–∫–æ —Ç–µ–ª–µ—Ñ–æ–Ω—ã)
--   - –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è cold calling CRM

-- –ü–æ—á–µ–º—É –Ω–µ –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–º–µ—é—Ç email –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏?
--   - –í HubSpot CRM –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –¢–û–õ–¨–ö–û —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º
--   - Email –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ (—Ç–æ–ª—å–∫–æ ~20% –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤)
--   - –û—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä = phone (100% –∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
--   - Phone matching —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (118k calls matched)

-- –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?
--   - Email –∫–æ–ª–æ–Ω–∫–∞ —Ç–µ–ø–µ—Ä—å —á–∏—Å—Ç–∞—è (—Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –∏–ª–∏ NULL)
--   - –î–ª—è –º–µ—Ç—Ä–∏–∫ email –ù–ï –Ω—É–∂–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ–º phone)
--   - –î–ª—è –±—É–¥—É—â–∏—Ö incremental sync:
--     * –î–æ–±–∞–≤–∏—Ç—å validation –≤ sync script transform function
--     * –ù–µ –∏–∑–≤–ª–µ–∫–∞—Ç—å hs_full_name_or_email –≤ email –∫–æ–ª–æ–Ω–∫—É
--     * –û—Å—Ç–∞–≤–∏—Ç—å raw_json –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö

-- =====================================================================
-- FUTURE: Incremental Sync Prevention
-- =====================================================================

-- –í sync-parallel.js –¥–æ–±–∞–≤–∏—Ç—å validation:
--
-- const emailValue = contact.properties.email ||
--                    contact.properties.hs_full_name_or_email;
-- const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
--
-- return {
--   email: (emailValue && EMAIL_REGEX.test(emailValue)) ? emailValue : null,
--   // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
-- };

-- =====================================================================
-- END OF MIGRATION 018
-- =====================================================================
